# æ•°æ®å“åº”å¼

## é¢„å…ˆå‡†å¤‡

### å“åº”å¼åŸç†

å€ŸåŠ© [Object.defineReactive](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)ï¼Œå¯ä»¥å¯¹ä¸€ä¸ª**å¯¹è±¡**çš„æŸä¸ª`key`è¿›è¡Œ **get** å’Œ **set** çš„æ‹¦æˆªï¼Œä½†æœ‰ä¸¤ä¸ªç¼ºé™·

1. éœ€è¦æ‹¦æˆªå¯¹è±¡çš„æ¯ä¸ª**key**ï¼Œå¦‚æœæ–°æ·»åŠ äº†**key**ï¼Œéœ€è¦å¯¹æ–°åŠ çš„**key**æ‰§è¡Œæ‹¦æˆª
2. æ— æ³•ç›‘å¬æ•°ç»„å˜åŒ–

### ä¸‰ä¸ªæ¦‚å¿µ åŠ å‘å¸ƒè®¢é˜…æ¨¡å¼

psï¼šè¿™é‡ŒåªåšåŸç†ç®€æï¼Œä¸‹æ–‡ä¼šå…·ä½“æåˆ°è¯¦ç»†çš„**dep å’Œ watcher äº’ç›¸å¼•ç”¨**ç­‰ç»†èŠ‚é—®é¢˜ã€‚

1. Observer<br/>
   å‘å¸ƒè€…ï¼šæ¯ä¸ªå¯¹è±¡ï¼ˆåŒ…å«å­å¯¹è±¡ï¼‰æœ‰ä¸€ä¸ª **Observer å®ä¾‹**ï¼Œå†…éƒ¨å­˜åœ¨ä¸€ä¸ª **dep**ï¼Œç”¨äºç®¡ç†å¤šä¸ª**Watcher**ï¼Œå½“æ•°æ®æ”¹å˜æ—¶ï¼Œé€šè¿‡ **dep** é€šçŸ¥ **Watcher** è¿›è¡Œæ›´æ–°
2. Dep<br/>
   å‘å¸ƒè®¢é˜…ä¸­å¿ƒï¼šå†…éƒ¨ç®¡ç†å¤šä¸ª**Watcher**
3. Watcher<br/>
   è®¢é˜…è€…ï¼šæ‰§è¡Œç»„ä»¶çš„åˆå§‹åŒ–å’Œæ›´æ–°æ–¹æ³•

### å®˜ç½‘çš„æµç¨‹å›¾

![avatar](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dba3e19f179a4e7cbf0d62402cffb756~tplv-k3u1fbpfcp-zoom-1.image)

## ä»æºç æ¢ç©¶æµç¨‹

åˆå§‹åŒ–æ‰§è¡Œ`_init`æ—¶æœ‰ä¸€ä¸ªå‡½æ•°å«åš`initState`ï¼Œè¿™ä¾¿æ˜¯æ•°æ®å“åº”å¼çš„å…¥å£

### initState [/src/core/instance/state.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/state.js#L48)

- ä½œç”¨ï¼šåˆå§‹åŒ– `props`ã€`methods`ã€`data`ã€`computed` å’Œ `watch`ï¼Œå¹¶è¿›è¡Œ**å“åº”å¼å¤„ç†**
- æ ¸å¿ƒæºç 

  ```javascript
  const opts = vm.$options;
  // 1.props
  if (opts.props) initProps(vm, opts.props);
  // 2.methods
  if (opts.methods) initMethods(vm, opts.methods);
  // 3.data
  if (opts.data) {
    initData(vm);
  } else {
    observe((vm._data = {}), true /* asRootData */);
  }
  if (opts.computed) initComputed(vm, opts.computed);
  if (opts.watch && opts.watch !== nativeWatch) {
    initWatch(vm, opts.watch);
  }
  ```

  å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¯¹`_data`è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œå› æ­¤`_data`æ˜¯ä¸€ä¸ª**å“åº”å¼å¯¹è±¡**ï¼Œå¾ˆå¤š**Vue ç»„ä»¶**éƒ½å€ŸåŠ©äº†è¿™ä¸ªç‰¹ç‚¹è·å–**å“åº”å¼å¯¹è±¡**ï¼Œæ¯”å¦‚**Vuex**

  è¿™é‡Œéœ€è¦ç‰¹åˆ«å…³æ³¨`initData`æ–¹æ³•ï¼Œå…¶**æ ¸å¿ƒåŠŸèƒ½**æ˜¯å¯¹`data`è¿›è¡Œ**æ•°æ®å“åº”åŒ–**å¤„ç†

  ```javascript
  function initData(vm: Component) {
    const keys = Object.keys(data);
    let i = keys.length;
    while (i--) {
      const key = keys[i];

      proxy(vm, `_data`, key); // å°† å“åº”å¼æ•°æ® ä»£ç†åˆ° this ä¸Šé¢
    }
    // æ‰§è¡Œæ•°æ®å“åº”åŒ–
    observe(data, true /* asRootData */);
  }
  ```

### å“åº”å¼åŸç†çš„å…¥å£ï¼šobserve [/src/core/observer/index.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js#L110)

- ä½œç”¨ï¼šä¸º **æ•°ç»„**/**(é™¤ VNode ä»¥å¤–çš„)å¯¹è±¡**/ åˆ›å»º **Observer**

- æºç 

  ```javascript
  export function observe(value: any, asRootData: ?boolean): Observer | void {
    if (!isObject(value) || value instanceof VNode) {
      return;
    }
    let ob: Observer | void;
    if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
      ob = value.__ob__;
    } else if (
      shouldObserve &&
      !isServerRendering() &&
      (Array.isArray(value) || isPlainObject(value)) &&
      Object.isExtensible(value) &&
      !value._isVue
    ) {
      ob = new Observer(value);
    }
    if (asRootData && ob) {
      ob.vmCount++;
    }
    return ob;
  }
  ```

  (ps:å¼€å‘ç¯å¢ƒä¸‹ä¼šå¯¹`props`ï¼Œ`methods`æ ¡éªŒï¼Œé¿å…å‘½åå†²çª)

  è¿™é‡Œä¼šæœ‰ä¸ªç»†èŠ‚ï¼Œæ ¹æ®å¯¹è±¡æ˜¯å¦åŒ…å«`__ob__`é€‰æ‹©æ˜¯å¦å¤ç”¨ **Observer** ï¼Œè€Œ`__ob__`æ˜¯å“ªæ¥çš„å‘¢ï¼Œå…¶å®æ˜¯`new Observer`æ—¶æ“ä½œçš„

### Observer [/src/core/observer/index.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js#L37)

- ä½œç”¨

  1. ä¸º **å¯¹è±¡**/**æ•°ç»„** åˆ›å»º **Observer** å®ä¾‹ï¼Œå¹¶æŒ‚è½½åˆ°å¯¹è±¡çš„`__ob__`å±æ€§ä¸Šï¼Œ
  2. åˆ›å»º **dep**ï¼Œç”¨äº**æ•°ç»„å“åº”å¼**å’Œ`set`æ—¶ä½¿ç”¨

- æ ¸å¿ƒæºç 

  ```javascript
  class Observer {
    constructor(value: any) {
      this.dep = new Dep();

      // æŒ‡å®šobå®ä¾‹
      def(value, '__ob__', this);
      if (Array.isArray(value)) {
        // è¦†ç›–åŸå‹
        if (hasProto) {
          protoAugment(value, arrayMethods);
        } else {
          copyAugment(value, arrayMethods, arrayKeys);
        }
        // è§‚å¯Ÿæ•°ç»„
        this.observeArray(value);
      } else {
        // è§‚å¯Ÿå¯¹è±¡
        this.walk(value);
      }
    }
    walk(obj: Object) {
      const keys = Object.keys(obj);
      for (let i = 0; i < keys.length; i++) {
        defineReactive(obj, keys[i]);
      }
    }

    observeArray(items: Array<any>) {
      for (let i = 0, l = items.length; i < l; i++) {
        observe(items[i]);
      }
    }
  }
  ```

  å› ä¸º**æ•°ç»„å…ƒç´ **æ— æ³•ç›´æ¥è¢«`Object.defineProperty`æ‹¦æˆªï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬å¤„ç†ã€‚ä½†**æ•°ç»„å…ƒç´ **å¯èƒ½æ˜¯ä¸ª**å¯¹è±¡**ï¼Œå› æ­¤éœ€è¦éå†æ•°ç»„è§‚å¯Ÿé‡Œé¢çš„å…ƒç´ 

### è§‚å¯Ÿå¯¹è±¡ï¼šdefineReactive [/src/core/observer/index.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js#L135)

- ä½œç”¨ï¼š
  1. é€šè¿‡`Object.defineProperty`ä¸º**å¯¹è±¡**çš„**key**è¿›è¡Œæ‹¦æˆªï¼Œ
  2. ä¸ºå¯¹è±¡çš„`key`åˆ›å»º**dep**ï¼Œç”¨äº`key`å¯¹åº”çš„`value`å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥ç»„ä»¶æ›´æ–°
- æ ¸å¿ƒæºç 

  ```javascript
  function defineReactive(obj: Object, key: string, val: any, customSetter?: ?Function) {
    const dep = new Dep();

    let childOb = observe(val);

    Object.defineProperty(obj, key, {
      get: function reactiveGetter() {
        const value = getter ? getter.call(obj) : val;
        if (Dep.target) {
          dep.depend();
          if (childOb) {
            childOb.dep.depend();
            if (Array.isArray(value)) {
              dependArray(value);
            }
          }
        }
        return value;
      },
      set: function reactiveSetter(newVal) {
        const value = getter ? getter.call(obj) : val;
        /* eslint-disable no-self-compare */
        if (newVal === value || (newVal !== newVal && value !== value)) {
          return;
        }
        // #7981: for accessor properties without setter
        // ...
        val = newVal;
        childOb = observe(newVal);
        dep.notify();
      },
    });
  }
  ```

  **getter** è´Ÿè´£æ·»åŠ ä¾èµ–ï¼Œ**setter** ä¸»è¦è´Ÿè´£ä¸¤ä»¶äº‹

  - 1.  **å†…å®¹**æœ‰å˜åŒ–æ—¶**é€šçŸ¥ dep æ›´æ–° watcher**
  - 2.  **è§‚å¯Ÿæ–°è®¾ç½®çš„å€¼(æ–°è®¾ç½®çš„å€¼å¯èƒ½ä¹Ÿæ˜¯ä¸ªå¯¹è±¡)**

  æˆ–è®¸ä½ ä¼šæœ‰ä¸ªå°ç–‘é—®ï¼Œæ‰§è¡Œ`setter`æ—¶ä¸ºä»€ä¹ˆåªæ”¹å½¢å‚`val`å‘¢ï¼Ÿ

  å…¶å®è¿™æ˜¯**JavaScript** çš„ **é—­åŒ…** ç‰¹æ€§ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œé—­åŒ…ä¸ºå½“å‰å‡½æ•°æä¾›äº†ä¸€ä¸ªä½œç”¨åŸŸï¼Œæ¯æ¬¡`setter`è¢«è§¦å‘éƒ½ä¼šä»å½“å‰ä½œç”¨åŸŸä¸‹å–å‡ºå˜é‡`val`ï¼Œ`getter`æ—¶è¿”å›è¿™ä¸ª`val`ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡æ“ä½œéƒ½å€¼éƒ½æ˜¯å½“å‰ä½œç”¨åŸŸä¸‹çš„`val`ã€‚

### è§‚å¯Ÿæ•°ç»„ï¼šæ–¹æ³•è¦†ç›– [/src/core/observer/array.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/array.js)

- ä½œç”¨
  - æ•°ç»„æœ‰ 7 ä¸ªæ”¹å˜å…ƒç´ çš„æ–¹æ³•ï¼Œå¯¹è¿™ 7 ä¸ªæ–¹æ³•æ·»åŠ é¢å¤–çš„åŠŸèƒ½
    - 1. è§‚å¯Ÿæ–°æ·»åŠ çš„å…ƒç´ ï¼Œå®ç°æ•°ç»„å†…éƒ¨å…ƒç´ æ•°æ®å“åº”å¼
    - 2. å–å‡ºæ•°ç»„èº«ä¸Šçš„`__ob__`ï¼Œè®©ä»–çš„`dep`é€šçŸ¥`watcher`æ›´æ–°è§†å›¾ï¼Œå®ç°æ•°ç»„å“åº”å¼
- æ ¸å¿ƒæºç 

  ```javascript
  // è·å–æ•°ç»„åŸå‹
  const arrayProto = Array.prototype;
  // å…‹éš†ä¸€ä»½
  export const arrayMethods = Object.create(arrayProto);

  // 7ä¸ªå˜æ›´æ–¹æ³•éœ€è¦è¦†ç›–
  const methodsToPatch = ['push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse'];

  /**
   * Intercept mutating methods and emit events
   */
  methodsToPatch.forEach(function (method) {
    // cache original method
    // ä¿å­˜åŸå§‹æ–¹æ³•
    const original = arrayProto[method];
    // è¦†ç›–ä¹‹
    def(arrayMethods, method, function mutator(...args) {
      // 1.æ‰§è¡Œé»˜è®¤æ–¹æ³•
      const result = original.apply(this, args);
      // 2.å˜æ›´é€šçŸ¥
      const ob = this.__ob__;
      // å¯èƒ½ä¼šæœ‰æ–°å…ƒç´ åŠ å…¥
      let inserted;
      switch (method) {
        case 'push':
        case 'unshift':
          inserted = args;
          break;
        case 'splice':
          inserted = args.slice(2);
          break;
      }
      // å¯¹æ–°åŠ å…¥çš„å…ƒç´ åšå“åº”å¼
      if (inserted) ob.observeArray(inserted);
      // notify change
      // obå†…éƒ¨æœ‰ä¸€ä¸ªdepï¼Œè®©å®ƒå»é€šçŸ¥æ›´æ–°
      ob.dep.notify();
      return result;
    });
  });
  ```

  è¿˜è®°å¾—å—ï¼Œåœ¨åˆ›å»º`Observer`å®ä¾‹æ—¶ç»™å¯¹è±¡æ·»åŠ äº†ä¸€ä¸ª**dep**ï¼Œè¿™é‡Œå¯ä»¥å–å‡ºæ¥ï¼Œè°ƒç”¨`notify`æ–¹æ³•é€šçŸ¥æ›´æ–°ï¼Œæ›´æ–°æ—¶ä¼šè§¦å‘æ•°ç»„æ–°æ·»åŠ å…ƒç´ çš„`getter`æ–¹æ³•ï¼Œ**watcher**æ›´æ–°æ—¶ä¹Ÿä¼šå†æ¬¡è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œä»¥æ­¤å®Œæˆæ•°ç»„çš„**æ•°æ®å“åº”å¼**

### Dep [/src/core/observer/dep.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/dep.js#L13)

- ä½œç”¨ï¼š
  - **Dep** è´Ÿè´£ç®¡ç†ä¸€ç»„ **Watcher**ï¼ŒåŒ…æ‹¬ **Watcher** å®ä¾‹çš„**å¢åˆ **åŠ**é€šçŸ¥æ›´æ–°**
- æ ¸å¿ƒæºç 

  ```javascript
  class Dep {
    constructor() {
      this.id = uid++;
      this.subs = [];
    }

    // ç”¨äºå’Œwatcherå»ºç«‹è¿æ¥
    addSub(sub: Watcher) {
      this.subs.push(sub);
    }

    // ç”¨äºå’Œwatcherå–æ¶ˆå¼•ç”¨
    removeSub(sub: Watcher) {
      remove(this.subs, sub);
    }

    // ç”¨äºæ·»åŠ watcheråˆ°è‡ªå·±
    depend() {
      if (Dep.target) {
        Dep.target.addDep(this);
      }
    }

    // ç”¨äºé€šçŸ¥watcheræ›´æ–°
    notify() {
      // stabilize the subscriber list first
      const subs = this.subs.slice();
      for (let i = 0, l = subs.length; i < l; i++) {
        subs[i].update();
      }
    }
  }
  ```

  **Dep** å’Œ **Watcher** ç›¸äº’å¼•ç”¨ï¼Œå¯ä»¥é€šçŸ¥ **Watcher** äº’ç›¸æ·»åŠ ï¼Œä¹Ÿå¯ä»¥é€šçŸ¥ **Watcher** äº’ç›¸åˆ é™¤ï¼Œè¿™é‡Œäº’ç›¸æ·»åŠ å’Œäº’ç›¸åˆ é™¤éƒ½æ˜¯ä¸ºäº†å¤„ç†`vm.$delete`çš„æƒ…å†µ

### Watcher [/src/core/observer/watcher.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/watcher.js#L26)

- ä½œç”¨ï¼š
  1. åˆ†ä¸º **render Watcher** å’Œ **user Watcher**ï¼Œ
  2. **user Watcher**ç”¨äº `watch`ã€`computed`ï¼Œ
  3. **render Watcher**ç”¨äºç»„ä»¶**åˆå§‹åŒ–**å’Œ**æ›´æ–°**ï¼Œæ‰§è¡Œç²’åº¦æ˜¯ `render` æ•´ä¸ªç»„ä»¶ï¼Œå­˜åœ¨äºå¯¹è±¡è§‚å¯Ÿè€…çš„**dep**ä¸­
  4. ç”±äº**å¯¹è±¡**å­˜åœ¨**åˆ é™¤ key**çš„æƒ…å†µï¼Œå¦‚æœ**key**å­˜åœ¨ä¾èµ–çš„**watcher**ï¼Œæ­¤æ—¶å°±éœ€è¦åˆ é™¤æ‰ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥åœ¨**watcher**å†…éƒ¨åŒæ ·éœ€è¦å’Œ**dep**å»ºç«‹å¼•ç”¨ï¼Œç”¨äºåç»­çš„**åˆ é™¤ key**æ“ä½œ
- æ ¸å¿ƒæºç 

  ```javascript
  class Watcher {
    vm: Component;
    expression: string;
    cb: Function;
    id: number;
    deep: boolean;
    user: boolean;
    lazy: boolean;
    sync: boolean;
    dirty: boolean;
    active: boolean;
    deps: Array<Dep>;
    newDeps: Array<Dep>;
    depIds: SimpleSet;
    newDepIds: SimpleSet;
    before: ?Function;
    getter: Function;
    value: any;

    constructor(
      vm: Component,
      expOrFn: string | Function,
      cb: Function,
      options?: ?Object,
      isRenderWatcher?: boolean
    ) {
      this.vm = vm;
      // ç”¨äº vm.forceUpdate
      if (isRenderWatcher) {
        vm._watcher = this;
      }
      vm._watchers.push(this);
      // options
      if (options) {
        this.deep = !!options.deep;
        this.user = !!options.user;
        this.lazy = !!options.lazy;
        this.sync = !!options.sync;
        this.before = options.before;
      } else {
        this.deep = this.user = this.lazy = this.sync = false;
      }
      this.cb = cb;
      this.id = ++uid; // uid for batching
      this.active = true;
      this.dirty = this.lazy; // for lazy watchers
      this.deps = [];
      this.newDeps = [];
      this.depIds = new Set();
      this.newDepIds = new Set();
      this.expression = process.env.NODE_ENV !== 'production' ? expOrFn.toString() : '';
      // parse expression for getter
      // åˆå§‹åŒ– çš„æ—¶å€™å‚æ•°2å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ç›´æ¥èµ‹å€¼ç»™getter
      if (typeof expOrFn === 'function') {
        this.getter = expOrFn;
      } else {
        this.getter = parsePath(expOrFn);
        if (!this.getter) {
          this.getter = noop;
        }
      }
      this.value = this.lazy ? undefined : this.get();
    }

    // æ‰§è¡Œæ›´æ–°ï¼Œé‡æ–°æ”¶é›†ä¾èµ–ï¼ˆåˆå§‹åŒ–ä¸æ›´æ–°éƒ½ä¼šå†æ¬¡æ‰§è¡Œè¿™é‡Œï¼‰
    get() {
      pushTarget(this);
      let value;
      const vm = this.vm;
      try {
        value = this.getter.call(vm, vm);
      } catch (e) {
        if (this.user) {
          handleError(e, vm, `getter for watcher "${this.expression}"`);
        } else {
          throw e;
        }
      } finally {
        // æ·±åº¦ç›‘å¬
        if (this.deep) {
          traverse(value);
        }
        popTarget();
        this.cleanupDeps();
      }
      return value;
    }

    // æ·»åŠ watcheråˆ°subs
    addDep(dep: Dep) {
      const id = dep.id;
      // ç›¸äº’æ·»åŠ å¼•ç”¨
      if (!this.newDepIds.has(id)) {
        // watcheræ·»åŠ dep
        this.newDepIds.add(id);
        this.newDeps.push(dep);
        if (!this.depIds.has(id)) {
          // depæ·»åŠ watcher
          dep.addSub(this);
        }
      }
    }

    // æ¸…é™¤ä¾èµ–ï¼Œæ›´æ–°å’Œåˆå§‹åŒ–å¹¶ä¸ä¼šå®é™…æ‰§è¡Œï¼Œå› ä¸ºnewDepIdsä¸­æ²¡æœ‰å†…å®¹
    cleanupDeps() {
      let i = this.deps.length;
      while (i--) {
        const dep = this.deps[i];
        if (!this.newDepIds.has(dep.id)) {
          dep.removeSub(this);
        }
      }
      let tmp = this.depIds;
      this.depIds = this.newDepIds;
      this.newDepIds = tmp;
      this.newDepIds.clear();
      tmp = this.deps;
      this.deps = this.newDeps;
      this.newDeps = tmp;
      this.newDeps.length = 0;
    }

    // ç»„ä»¶æ›´æ–° computed watch
    update() {
      /* istanbul ignore else */
      // computed
      if (this.lazy) {
        this.dirty = true;
      } else if (this.sync) {
        this.run();
      } else {
        // å¼‚æ­¥æ›´æ–° watcherå…¥é˜Ÿ
        queueWatcher(this);
      }
    }

    // åŒæ­¥æ‰§è¡Œçš„watcherï¼Œasync:true
    run() {
      if (this.active) {
        // å¦‚æœæ˜¯ç»„ä»¶çº§åˆ«watcherï¼Œåªèµ°ä¸‹é¢get
        const value = this.get();
        if (
          value !== this.value ||
          // Deep watchers and watchers on Object/Arrays should fire even
          // when the value is the same, because the value may
          // have mutated.
          isObject(value) ||
          this.deep
        ) {
          // set new value
          const oldValue = this.value;
          this.value = value;
          if (this.user) {
            try {
              this.cb.call(this.vm, value, oldValue);
            } catch (e) {
              handleError(e, this.vm, `callback for watcher "${this.expression}"`);
            }
          } else {
            this.cb.call(this.vm, value, oldValue);
          }
        }
      }
    }

    // ä¸ç«‹å³è§¦å‘çš„watcherï¼Œimmediate:false
    evaluate() {
      this.value = this.get();
      this.dirty = false;
    }

    // å’Œ watcher äº’ç›¸å¼•ç”¨
    depend() {
      let i = this.deps.length;
      while (i--) {
        this.deps[i].depend();
      }
    }

    // å–æ¶ˆç›‘å¬ï¼Œå’Œ watcher äº’ç›¸åˆ é™¤ å¼•ç”¨
    teardown() {
      if (this.active) {
        // remove self from vm's watcher list
        // this is a somewhat expensive operation so we skip it
        // if the vm is being destroyed.
        if (!this.vm._isBeingDestroyed) {
          remove(this.vm._watchers, this);
        }
        let i = this.deps.length;
        while (i--) {
          this.deps[i].removeSub(this);
        }
        this.active = false;
      }
    }
  }
  ```

  å³ä½¿åªé€‰å–äº† Watcher çš„æ ¸å¿ƒæºç ï¼Œä½†å†…å®¹ä¾ç„¶å¾ˆå¤šï¼Œä¸»è¦åŒ…æ‹¬é‡æ–°æ”¶é›†ä¾èµ–çš„è¿‡ç¨‹ï¼ŒæŠ›å¼€è¿™äº›ä¸è°ˆçš„åŒ–ï¼Œå…¶å®**Watcher**åªæœ‰åˆå§‹åŒ–æ—¶ä¸€æ¬¡æ›´æ–°ï¼Œä»¥åŠåç»­æ›´æ–°ä½¿ç”¨çš„`update`æ–¹æ³•ã€‚

## æµç¨‹æ¢³ç†

1. **Vue**åˆå§‹åŒ–æ—¶è°ƒç”¨`this._init`ï¼Œå…¶ä¸­`initState`æ–¹æ³•ç”¨äºåˆå§‹åŒ–**å“åº”å¼æ•°æ®**
2. é¦–å…ˆå°†`_data`ä»£ç†åˆ°å®ä¾‹ä¸Šï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡`this`è°ƒç”¨ï¼Œç„¶åå¯¹`_data`è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œæ¯ä¸ªè¢«è§‚å¯Ÿçš„`value`éƒ½å¤šäº†ä¸€ä¸ª`__ob__`å±æ€§
3. æ¯ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ª**dep**ï¼Œç”¨äº**æ•°ç»„**å’Œ`Vue.set`ä½¿ç”¨ï¼Œæ¯ä¸ª**key**ä¹Ÿæ‹¥æœ‰ä¸€ä¸ª**dep**ï¼Œ`getter`æ—¶æ”¶é›†ä¾èµ–ï¼ˆwatcherï¼‰ï¼Œ`setter`æ—¶é€šçŸ¥ä¾èµ–ï¼ˆwatcherï¼‰æ›´æ–°
4. å¯¹äºæ•°ç»„é‡‡ç”¨**æ–¹æ³•è¦†ç›–**çš„æ–¹æ³•ï¼Œ**7 ä¸ªæ–¹æ³•**åœ¨æ‰§è¡Œæ—¶è¿½åŠ ä¸€ä¸ªé¢å¤–çš„æ“ä½œï¼Œè§‚å¯Ÿæ–°å¢çš„å…ƒç´ ï¼Œç„¶åè®©æ•°ç»„çš„`__ob__`é€šçŸ¥**watcher**è¿›è¡Œæ›´æ–°

## æ€»ç»“ä¸æ€è€ƒ

1. **dep**å’Œ**watcher** çš„å…³ç³»ä¸ºä»€ä¹ˆè®¾è®¡æˆå¤šå¯¹å¤šï¼Ÿ<br>

   - é¦–å…ˆè¦æ˜ç™½çš„æ¦‚å¿µæ˜¯ï¼Œ**watcher**åŒ…å«**render Watcher**å’Œ**user watcher**ï¼Œ
   - å…¶æ¬¡ï¼Œä¸€ä¸ª**key**æ‹¥æœ‰ä¸€ä¸ª**dep**ï¼Œ
     - ä¸€ä¸ª**key**å¯èƒ½é€šè¿‡**props**ç»‘å®šç»™å¤šä¸ªç»„ä»¶ï¼Œè¿™å°±æœ‰å¤šä¸ª**render Watcher**
     - å¦‚æœåœ¨ç»„ä»¶ä¸­ä½¿ç”¨äº†`computed`ã€`watch`ï¼Œè¿™å°±åˆæ·»åŠ äº†**user Watcher**
     - åˆ°è¿™é‡Œï¼Œ**dep**å’Œ**watcher**æ˜¯ä¸€å¯¹å¤š
   - Vue2 å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œ**render Watcher**çš„æ›´æ–°ç²’åº¦æ˜¯æ•´ä¸ªç»„ä»¶ï¼Œå¯¹äºä¸€ä¸ªç»„ä»¶ï¼Œé€šå¸¸æœ‰å¤šä¸ªå¯ä»¥è§¦å‘æ›´æ–°çš„ keyï¼Œåˆå› ä¸ºä¸€ä¸ª**key**ä¸€ä¸ª**dep**ï¼Œè¿™ç§æƒ…å†µä¸‹**dep**å’Œ**watcher**æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»
   - æ‰€ä»¥ç»¼åˆä¸Šé¢ä¸¤ç§æƒ…å†µï¼Œ**dep**å’Œ**watcher**è¢«è®¾è®¡æˆ**å¤šå¯¹å¤š**çš„å…³ç³»

2. ä¸€ä¸ª**key**éœ€è¦ä¸€ä¸ª**dep**ï¼Œç”¨äºè§¦å‘**render Watcher**è¿™ä¸ªæˆ‘æ˜ç™½ï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡è¿˜éœ€è¦ä¸€ä¸ª**key**å‘¢ï¼Ÿ<br>
   ç”¨äº`Vue.set`å’Œæ•°ç»„æ›´æ–°ä½¿ç”¨

3. ä¸ºä»€ä¹ˆéœ€è¦`Vue.set`ï¼Œå…¶åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ<br>

   - 1. é¦–å…ˆå¯¹æ–°æ·»åŠ çš„ **key** è¿›è¡Œç›‘å¬ï¼Œç»è¿‡`defineReactive`æ–¹æ³•ï¼Œé¦–å…ˆæ–°åŠ å…¥çš„å…ƒç´ ä¼šå˜æˆå“åº”å¼ï¼Œå…¶æ¬¡å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ª**dep**
   - 2. å–å‡ºå¯¹è±¡èº«ä¸Šçš„ **dep**ï¼Œè°ƒç”¨ `notify` æ–¹æ³•ï¼Œé€šçŸ¥ **Watcher** æ›´æ–°è§†å›¾ï¼Œåœ¨**æ›´æ–°è§†å›¾**æ—¶ä¼šå†æ¬¡èµ°åˆ°`get`æ–¹æ³•(ç”¨äºåˆå§‹åŒ–å’Œæ›´æ–°æ—¶è°ƒç”¨)ï¼Œå°†å½“å‰**Watcher**æ”¶åˆ°æ–°å¢ **key** çš„ **dep** ä¸­ï¼Œå®Œæˆ**ä¾èµ–æ”¶é›†**

4. ç»¼åˆ**æ•°æ®å“åº”å¼åŸç†**ï¼Œæ„Ÿè§‰æœ€å¤æ‚çš„éƒ¨åˆ†åœ¨äºå¤„ç† **æ•°ç»„** å’Œ **æ–°å¢ key** çš„æƒ…å†µï¼Œå¤„ç†è¿™ä¸¤ç§æƒ…å†µçš„å¤§é‡é€»è¾‘éƒ½åœ¨**Watcher**ä¸­ï¼Œå¯¼è‡´**Watcher**çš„æºç è¯»èµ·æ¥å¾ˆéº»çƒ¦ï¼Œè¿™ä¹Ÿæ˜¯åæ¥**Vue3**ç€é‡ä¼˜åŒ–çš„ä¸€éƒ¨åˆ†ã€‚åç»­ä¸“é—¨æ•´ç†ä¸‹**Vue3**çš„å˜åŒ–ä»¥ä½œå¯¹æ¯” ğŸš©
