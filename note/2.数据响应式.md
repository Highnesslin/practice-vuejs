# æ•°æ®å“åº”å¼

## é¢„å…ˆå‡†å¤‡

### å“åº”å¼åŸç†

&emsp;&emsp;å€ŸåŠ© [Object.defineReactive](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)ï¼Œå¯ä»¥å¯¹ä¸€ä¸ª**å¯¹è±¡**çš„æŸä¸ª`key`è¿›è¡Œ **get** å’Œ **set** çš„æ‹¦æˆªï¼Œ**get** æ—¶è¿›è¡Œ **ä¾èµ–æ”¶é›†**ï¼Œ**set** æ—¶ **è§¦å‘ä¾èµ–**

ä½†`Object.defineReactive`æœ‰ä¸¤ä¸ªç¼ºé™·

1. æ— æ³•ç›‘å¬åŠ¨æ€æ·»åŠ çš„å±æ€§
2. æ— æ³•ç›‘å¬æ•°ç»„å˜åŒ–

### ä¸‰ä¸ªæ¦‚å¿µ åŠ å‘å¸ƒè®¢é˜…æ¨¡å¼

(psï¼šè¿™é‡ŒåªåšåŸç†ç®€æï¼Œä¸‹æ–‡ä¼šå…·ä½“æåˆ°è¯¦ç»†çš„ **dep å’Œ watcher äº’ç›¸å¼•ç”¨** ç­‰ç»†èŠ‚é—®é¢˜ã€‚)

1. Observer<br/>
   å‘å¸ƒè€…ï¼šæ¯ä¸ªå¯¹è±¡ï¼ˆåŒ…å«å­å¯¹è±¡ï¼‰æœ‰ä¸€ä¸ª **Observer å®ä¾‹**ï¼Œå†…éƒ¨å­˜åœ¨ä¸€ä¸ª **dep**ï¼Œç”¨äºç®¡ç†å¤šä¸ª**Watcher**ï¼Œå½“æ•°æ®æ”¹å˜æ—¶ï¼Œé€šè¿‡ **dep** é€šçŸ¥ **Watcher** è¿›è¡Œæ›´æ–°
2. Dep<br/>
   å‘å¸ƒè®¢é˜…ä¸­å¿ƒï¼šå†…éƒ¨ç®¡ç†å¤šä¸ª**Watcher**
3. Watcher<br/>
   è®¢é˜…è€…ï¼šæ‰§è¡Œç»„ä»¶çš„åˆå§‹åŒ–å’Œæ›´æ–°æ–¹æ³•

### æµç¨‹ä¸€è§ˆ

å®˜ç½‘çš„æµç¨‹å›¾
![avatar](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dba3e19f179a4e7cbf0d62402cffb756~tplv-k3u1fbpfcp-zoom-1.image)

åˆå§‹åŒ–æ—¶è¿›è¡Œæ•°æ®å“åº”å¼æ“ä½œå’Œåˆ›å»º**ç»„ä»¶ Watcher**ï¼Œ

- å‰è€…ä¸ºå¯¹è±¡çš„æ¯ä¸ª`key`è¿›è¡Œ`getter`/`setter`æ‹¦æˆªï¼Œå¹¶åˆ›å»º`dep`ï¼Œ
- è€Œ**ç»„ä»¶ Watcher**è´Ÿè´£ç»„ä»¶çš„æ¸²æŸ“å’Œæ›´æ–°ã€‚

&emsp;&emsp;**ç»„ä»¶ Watcher**åœ¨åˆ›å»ºæ—¶ä¼šæ‰§è¡Œä¸€æ¬¡ç»„ä»¶çš„`render`å‡½æ•°ï¼Œä»è€Œé—´æ¥è§¦å‘ç›¸å…³`key`çš„`getter`æ–¹æ³•ï¼Œå°†**Watcher**æ”¶é›†åˆ°`key`çš„`dep`ä¸­ï¼Œ
å½“æˆ‘ä»¬æ›´æ”¹`key`çš„å€¼æ—¶ä¼šè§¦å‘`key`çš„`setter`æ–¹æ³•ï¼Œé€šè¿‡`key`çš„`dep`é€šçŸ¥**Watcher**è¿›è¡Œæ›´æ–°ã€‚

## ä»æºç æ¢ç©¶æµç¨‹

&emsp;&emsp;è¿˜è®°å¾—å—ï¼Œåˆå§‹åŒ–æ‰§è¡Œäº†`_init`æ–¹æ³•ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå‡½æ•°`initState`ï¼Œè¿™ä¾¿æ˜¯**æ•°æ®å“åº”å¼**çš„å…¥å£

### initState [/src/core/instance/state.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/state.js#L48)

- ä½œç”¨
  - åˆå§‹åŒ– `props`ã€`methods`ã€`data`ã€`computed` å’Œ `watch`ï¼Œå¹¶è¿›è¡Œ **å“åº”å¼å¤„ç†**
- æ ¸å¿ƒæºç 

  ```javascript
  const opts = vm.$options;
  // 1.props
  if (opts.props) initProps(vm, opts.props);
  // 2.methods
  if (opts.methods) initMethods(vm, opts.methods);
  // 3.data
  if (opts.data) {
    initData(vm);
  } else {
    observe((vm._data = {}), true /* asRootData */);
  }
  if (opts.computed) initComputed(vm, opts.computed);
  if (opts.watch && opts.watch !== nativeWatch) {
    initWatch(vm, opts.watch);
  }
  ```

  &emsp;&emsp;å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå“åº”å¼å¤„ç†çš„å¯¹è±¡æ˜¯`_data`ï¼Œå› æ­¤`_data`å°†æ¥æ˜¯ä¸€ä¸ª**å“åº”å¼å¯¹è±¡**ï¼Œå¾ˆå¤š**Vue ç»„ä»¶**éƒ½å€ŸåŠ©äº†è¿™ä¸ªç‰¹ç‚¹æ¥è·å–**å“åº”å¼å†…å®¹**ï¼Œæ¯”å¦‚**Vuex**

  &emsp;&emsp;è¿™é‡Œéœ€è¦ç‰¹åˆ«å…³æ³¨`initData`æ–¹æ³•ï¼Œå…¶**æ ¸å¿ƒåŠŸèƒ½**æ˜¯å¯¹æˆ‘ä»¬å¹³æ—¶å†™çš„`data`è¿›è¡Œ**æ•°æ®å“åº”åŒ–**å¤„ç†

  ```javascript
  function initData(vm: Component) {
    const keys = Object.keys(data);
    let i = keys.length;
    while (i--) {
      const key = keys[i];

      proxy(vm, '_data', key); // å°† å“åº”å¼æ•°æ® ä»£ç†åˆ° this ä¸Šé¢
    }
    // æ‰§è¡Œæ•°æ®å“åº”åŒ–
    observe(data, true /* asRootData */);
  }
  ```

  &emsp;&emsp;æˆ‘ä»¬ä¹‹æ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨ç»„ä»¶å†…éƒ¨é€šè¿‡`this`ä½¿ç”¨`data`ä¸­çš„å±æ€§ï¼Œæ˜¯å› ä¸ºè¿™é‡Œåšäº†ä¸€ä¸ª`proxy(vm, '_data', key)`çš„æ“ä½œï¼Œ`proxy`å¹¶æ²¡æœ‰å¤šå¤æ‚ï¼Œåªæ˜¯æŠŠ`_data`çš„æ“ä½œç›´æ¥äº¤ç»™`vm`å¤„ç†

  ```javascript
  function proxy(target: Object, sourceKey: string, key: string) {
    sharedPropertyDefinition.get = function proxyGetter() {
      return this[sourceKey][key];
    };
    sharedPropertyDefinition.set = function proxySetter(val) {
      this[sourceKey][key] = val;
    };
    Object.defineProperty(target, key, sharedPropertyDefinition);
  }
  ```

### è§‚å¯Ÿçš„å…¥å£ï¼šobserve [/src/core/observer/index.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js#L110)

- ä½œç”¨

  - **ä¸é‡å¤åœ°** ä¸º **æ•°ç»„** å’Œ **(é™¤ VNode ä»¥å¤–çš„)å¯¹è±¡** åˆ›å»º **Observer**å®ä¾‹

- æºç 

  ```javascript
  export function observe(value: any, asRootData: ?boolean): Observer | void {
    if (!isObject(value) || value instanceof VNode) {
      return;
    }
    let ob: Observer | void;
    if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
      ob = value.__ob__;
    } else if (
      shouldObserve &&
      !isServerRendering() &&
      (Array.isArray(value) || isPlainObject(value)) &&
      Object.isExtensible(value) &&
      !value._isVue
    ) {
      ob = new Observer(value);
    }
    if (asRootData && ob) {
      ob.vmCount++;
    }
    return ob;
  }
  ```

  (ps:å¼€å‘ç¯å¢ƒä¸‹ä¼šå¯¹`props`ï¼Œ`methods`æ ¡éªŒï¼Œé¿å…å‘½åå†²çª)

  &emsp;&emsp;è¿™é‡Œä¼šæœ‰ä¸ªç»†èŠ‚ï¼Œæ ¹æ®å¯¹è±¡æ˜¯å¦åŒ…å«`__ob__`é€‰æ‹©æ˜¯å¦å¤ç”¨ **Observer** ï¼Œè€Œ`__ob__`æ˜¯å“ªæ¥çš„å‘¢ï¼Œå…¶å®æ˜¯`new Observer`æ—¶æ“ä½œçš„

### Observer [/src/core/observer/index.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js#L37)

- ä½œç”¨

  - ä¸º **å¯¹è±¡**/**æ•°ç»„** åˆ›å»º **Observer** å®ä¾‹ï¼Œå¹¶æŒ‚è½½åˆ°å¯¹è±¡çš„`__ob__`å±æ€§ä¸Šï¼Œ
  - åˆ›å»º **dep**ï¼Œç”¨äº**æ•°ç»„çš„å“åº”å¼**å’Œ`Vue.set`æ—¶ä½¿ç”¨

- æ ¸å¿ƒæºç 

  ```javascript
  class Observer {
    constructor(value: any) {
      this.dep = new Dep();

      // æŒ‡å®šobå®ä¾‹
      def(value, '__ob__', this);
      if (Array.isArray(value)) {
        // è¦†ç›–åŸå‹
        if (hasProto) {
          protoAugment(value, arrayMethods);
        } else {
          copyAugment(value, arrayMethods, arrayKeys);
        }
        // è§‚å¯Ÿæ•°ç»„
        this.observeArray(value);
      } else {
        // è§‚å¯Ÿå¯¹è±¡
        this.walk(value);
      }
    }
    walk(obj: Object) {
      const keys = Object.keys(obj);
      for (let i = 0; i < keys.length; i++) {
        defineReactive(obj, keys[i]);
      }
    }

    observeArray(items: Array<any>) {
      for (let i = 0, l = items.length; i < l; i++) {
        observe(items[i]);
      }
    }
  }
  ```

  &emsp;&emsp;å› ä¸º**æ•°ç»„å…ƒç´ **æ— æ³•ç›´æ¥è¢«`Object.defineProperty`æ‹¦æˆªï¼Œåé¢ä¼š**å•ç‹¬å¤„ç†**ã€‚ä½†**æ•°ç»„å…ƒç´ **å¯èƒ½æ˜¯**å¯¹è±¡**ï¼Œå› æ­¤éœ€è¦è§‚å¯Ÿé‡Œé¢çš„å…ƒç´ ã€‚

#### è§‚å¯Ÿå¯¹è±¡ï¼šdefineReactive [/src/core/observer/index.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js#L135)

- ä½œç”¨ï¼š
  - é€šè¿‡`Object.defineProperty`ä¸º**å¯¹è±¡**çš„**key**è¿›è¡Œæ‹¦æˆªï¼Œ
  - ä¸ºå¯¹è±¡çš„`key`åˆ›å»º**dep**ï¼Œç”¨äº`key`å‘ç”Ÿå˜åŒ–æ—¶**é€šçŸ¥æ›´æ–°**
- æ ¸å¿ƒæºç 

  ```javascript
  function defineReactive(obj: Object, key: string, val: any, customSetter?: ?Function) {
    const dep = new Dep();

    let childOb = observe(val);

    Object.defineProperty(obj, key, {
      get: function reactiveGetter() {
        const value = getter ? getter.call(obj) : val;
        if (Dep.target) {
          dep.depend();
          if (childOb) {
            childOb.dep.depend();
            if (Array.isArray(value)) {
              dependArray(value);
            }
          }
        }
        return value;
      },
      set: function reactiveSetter(newVal) {
        const value = getter ? getter.call(obj) : val;
        /* eslint-disable no-self-compare */
        if (newVal === value || (newVal !== newVal && value !== value)) {
          return;
        }
        // #7981: for accessor properties without setter
        // ...
        val = newVal;
        childOb = observe(newVal);
        dep.notify();
      },
    });
  }
  ```

  **getter** è´Ÿè´£ä¸º è‡ªå·±å’Œå­å…ƒç´ **æ·»åŠ ä¾èµ–**ï¼Œ**setter** è´Ÿè´£ä¸¤ä»¶äº‹

  - **å†…å®¹**æœ‰å˜åŒ–æ—¶**é€šçŸ¥ dep æ›´æ–° watcher**
  - **è§‚å¯Ÿæ–°è®¾ç½®çš„å€¼(æ–°è®¾ç½®çš„å€¼å¯èƒ½ä¹Ÿæ˜¯ä¸ªå¯¹è±¡)**

  &emsp;&emsp;æˆ–è®¸ä½ ä¼šæœ‰ä¸ªå°ç–‘é—®ï¼Œæ‰§è¡Œ`setter`æ—¶ä¸ºä»€ä¹ˆåªæ”¹å½¢å‚`val`å‘¢ï¼Ÿ

  &emsp;&emsp;å…¶å®è¿™æ˜¯**JavaScript** çš„ **é—­åŒ…** ç‰¹æ€§ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œé—­åŒ…ä¸ºå½“å‰å‡½æ•°æä¾›äº†ä¸€ä¸ªä½œç”¨åŸŸï¼Œæ¯æ¬¡`setter`è¢«è§¦å‘éƒ½ä¼šä»å½“å‰ä½œç”¨åŸŸä¸‹å–å‡ºå˜é‡`val`ï¼Œ`getter`æ—¶è¿”å›è¿™ä¸ª`val`ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡æ“ä½œéƒ½å€¼éƒ½æ˜¯å½“å‰ä½œç”¨åŸŸä¸‹çš„`val`ã€‚

#### è§‚å¯Ÿæ•°ç»„ï¼šæ–¹æ³•è¦†ç›– [/src/core/observer/array.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/array.js)

- ä½œç”¨
  - æ•°ç»„æœ‰ 7 ä¸ªå¯ä»¥æ”¹å˜å†…éƒ¨å…ƒç´ çš„æ–¹æ³•ï¼Œå¯¹è¿™ 7 ä¸ªæ–¹æ³•æ‰©å±•é¢å¤–çš„åŠŸèƒ½
    - 1. è§‚å¯Ÿæ–°æ·»åŠ çš„å…ƒç´ ï¼Œå®ç°æ•°ç»„å†…éƒ¨å…ƒç´ æ•°æ®å“åº”å¼
    - 2. å–å‡ºæ•°ç»„èº«ä¸Šçš„`__ob__`ï¼Œè®©ä»–çš„`dep`é€šçŸ¥`watcher`æ›´æ–°è§†å›¾ï¼Œå®ç°æ•°ç»„å“åº”å¼
- æ ¸å¿ƒæºç 

  ```javascript
  // è·å–æ•°ç»„åŸå‹
  const arrayProto = Array.prototype;
  // å…‹éš†ä¸€ä»½
  export const arrayMethods = Object.create(arrayProto);

  // 7ä¸ªå˜æ›´æ–¹æ³•éœ€è¦è¦†ç›–
  const methodsToPatch = ['push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse'];

  /**
   * Intercept mutating methods and emit events
   */
  methodsToPatch.forEach(function (method) {
    // cache original method
    // ä¿å­˜åŸå§‹æ–¹æ³•
    const original = arrayProto[method];
    // è¦†ç›–ä¹‹
    def(arrayMethods, method, function mutator(...args) {
      // 1.æ‰§è¡Œé»˜è®¤æ–¹æ³•
      const result = original.apply(this, args);
      // 2.å˜æ›´é€šçŸ¥
      const ob = this.__ob__;
      // å¯èƒ½ä¼šæœ‰æ–°å…ƒç´ åŠ å…¥
      let inserted;
      switch (method) {
        case 'push':
        case 'unshift':
          inserted = args;
          break;
        case 'splice':
          inserted = args.slice(2);
          break;
      }
      // å¯¹æ–°åŠ å…¥çš„å…ƒç´ åšå“åº”å¼
      if (inserted) ob.observeArray(inserted);
      // notify change
      // obå†…éƒ¨æœ‰ä¸€ä¸ªdepï¼Œè®©å®ƒå»é€šçŸ¥æ›´æ–°
      ob.dep.notify();
      return result;
    });
  });
  ```

  &emsp;&emsp;è¿˜è®°å¾—å—ï¼Œåœ¨åˆ›å»º`Observer`å®ä¾‹æ—¶ç‰¹æ„ç»™**å¯¹è±¡**æ·»åŠ äº†ä¸€ä¸ª**dep**ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡**dep**è°ƒç”¨`notify`æ–¹æ³•é€šçŸ¥æ›´æ–°ï¼Œä»¥æ­¤å®ç°**æ•°ç»„**çš„**æ•°æ®å“åº”å¼**ã€‚

### Dep [/src/core/observer/dep.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/dep.js#L13)

- ä½œç”¨ï¼š
  - æ¯ä¸ªå®ä¾‹ç®¡ç†ä¸€ç»„ **Watcher å®ä¾‹**ï¼Œå¯ä»¥**é€šçŸ¥æ›´æ–°**
  - æ·»åŠ **Watcher å®ä¾‹**åˆ°è‡ªå·±
  - é€šçŸ¥**Watcher å®ä¾‹**æ·»åŠ æˆ–åˆ é™¤è‡ªå·±ï¼ˆäº’ç›¸æ·»åŠ æˆ–åˆ é™¤ï¼‰
- æ ¸å¿ƒæºç 

  ```javascript
  class Dep {
    constructor() {
      this.id = uid++;
      this.subs = [];
    }

    // ç”¨äºå’Œwatcherå»ºç«‹è¿æ¥
    addSub(sub: Watcher) {
      this.subs.push(sub);
    }

    // ç”¨äºå’Œwatcherå–æ¶ˆå¼•ç”¨
    removeSub(sub: Watcher) {
      remove(this.subs, sub);
    }

    // ç”¨äºæ·»åŠ watcheråˆ°è‡ªå·±
    depend() {
      if (Dep.target) {
        Dep.target.addDep(this);
      }
    }

    // ç”¨äºé€šçŸ¥watcheræ›´æ–°
    notify() {
      // stabilize the subscriber list first
      const subs = this.subs.slice();
      for (let i = 0, l = subs.length; i < l; i++) {
        subs[i].update();
      }
    }
  }
  ```

  &emsp;&emsp;**Dep** å’Œ **Watcher** ç›¸äº’å¼•ç”¨ï¼Œäº’ç›¸æ·»åŠ æ˜¯ä¸ºäº†å¤„ç†`Vue.set`ï¼Œäº’ç›¸åˆ é™¤æ˜¯ä¸ºäº†å¤„ç†`Vue.delete`ã€‚

### Watcher [/src/core/observer/watcher.js](https://github.com/vuejs/vue/blob/dev/src/core/observer/watcher.js#L26)

- ä½œç”¨ï¼š
  - åˆ†ä¸º **render Watcher** å’Œ **user Watcher**ï¼Œ
  - **user Watcher**ç”¨äº `watch`å’Œ`computed`ï¼Œ
  - **render Watcher**ç”¨äºç»„ä»¶**åˆå§‹åŒ–**å’Œ**æ›´æ–°**ï¼Œæ‰§è¡Œç²’åº¦æ˜¯ `render` æ•´ä¸ªç»„ä»¶
  - **å®ä¾‹**å­˜åœ¨äºå¯¹è±¡è§‚å¯Ÿè€…çš„**dep**ä¸­
  - å’Œ**dep**äº’ç›¸æ·»åŠ æˆ–åˆ é™¤
- æ ¸å¿ƒæºç 

  ```typescript
  class Watcher {
    vm: Component;
    expression: string;
    cb: Function;
    id: number;
    deep: boolean;
    user: boolean;
    lazy: boolean;
    sync: boolean;
    dirty: boolean;
    active: boolean;
    deps: Array<Dep>;
    newDeps: Array<Dep>;
    depIds: SimpleSet;
    newDepIds: SimpleSet;
    before: ?Function;
    getter: Function;
    value: any;

    constructor(
      vm: Component,
      expOrFn: string | Function,
      cb: Function,
      options?: ?Object,
      isRenderWatcher?: boolean
    ) {
      this.vm = vm;
      // ç”¨äº vm.forceUpdate
      if (isRenderWatcher) {
        vm._watcher = this;
      }
      vm._watchers.push(this);
      // options
      if (options) {
        this.deep = !!options.deep;
        this.user = !!options.user;
        this.lazy = !!options.lazy;
        this.sync = !!options.sync;
        this.before = options.before;
      } else {
        this.deep = this.user = this.lazy = this.sync = false;
      }
      this.cb = cb;
      this.id = ++uid; // uid for batching
      this.active = true;
      this.dirty = this.lazy; // for lazy watchers
      this.deps = [];
      this.newDeps = [];
      this.depIds = new Set();
      this.newDepIds = new Set();
      this.expression = process.env.NODE_ENV !== 'production' ? expOrFn.toString() : '';
      // parse expression for getter
      // åˆå§‹åŒ– çš„æ—¶å€™å‚æ•°2å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ç›´æ¥èµ‹å€¼ç»™getter
      if (typeof expOrFn === 'function') {
        this.getter = expOrFn;
      } else {
        this.getter = parsePath(expOrFn);
        if (!this.getter) {
          this.getter = noop;
        }
      }
      this.value = this.lazy ? undefined : this.get();
    }

    // æ‰§è¡Œæ›´æ–°ï¼Œé‡æ–°æ”¶é›†ä¾èµ–ï¼ˆåˆå§‹åŒ–ä¸æ›´æ–°éƒ½ä¼šå†æ¬¡æ‰§è¡Œè¿™é‡Œï¼‰
    get() {
      pushTarget(this);
      let value;
      const vm = this.vm;
      try {
        value = this.getter.call(vm, vm);
      } catch (e) {
        if (this.user) {
          handleError(e, vm, `getter for watcher "${this.expression}"`);
        } else {
          throw e;
        }
      } finally {
        // æ·±åº¦ç›‘å¬
        if (this.deep) {
          traverse(value);
        }
        // å½“å‰Watcherèµ‹å€¼ç»™Dep.targetï¼Œç”¨äºé‡æ–°æ”¶é›†ä¾èµ–
        popTarget();
        this.cleanupDeps();
      }
      return value;
    }

    // æ·»åŠ watcheråˆ°subs
    addDep(dep: Dep) {
      const id = dep.id;
      // ç›¸äº’æ·»åŠ å¼•ç”¨
      if (!this.newDepIds.has(id)) {
        // watcheræ·»åŠ dep
        this.newDepIds.add(id);
        this.newDeps.push(dep);
        if (!this.depIds.has(id)) {
          // depæ·»åŠ watcher
          dep.addSub(this);
        }
      }
    }

    // æ¸…é™¤ä¾èµ–ï¼Œæ›´æ–°å’Œåˆå§‹åŒ–å¹¶ä¸ä¼šå®é™…æ‰§è¡Œï¼Œå› ä¸ºnewDepIdsä¸­æ²¡æœ‰å†…å®¹
    cleanupDeps() {
      let i = this.deps.length;
      while (i--) {
        const dep = this.deps[i];
        if (!this.newDepIds.has(dep.id)) {
          dep.removeSub(this);
        }
      }
      let tmp = this.depIds;
      this.depIds = this.newDepIds;
      this.newDepIds = tmp;
      this.newDepIds.clear();
      tmp = this.deps;
      this.deps = this.newDeps;
      this.newDeps = tmp;
      this.newDeps.length = 0;
    }

    // ç»„ä»¶æ›´æ–°ã€computedã€watch
    update() {
      /* istanbul ignore else */
      // computed
      if (this.lazy) {
        this.dirty = true;
      } else if (this.sync) {
        this.run();
      } else {
        // å¼‚æ­¥æ›´æ–° watcherå…¥é˜Ÿ
        queueWatcher(this);
      }
    }

    // åŒæ­¥æ‰§è¡Œçš„watcherï¼Œasync:true
    run() {
      if (this.active) {
        // å¦‚æœæ˜¯ç»„ä»¶çº§åˆ«watcherï¼Œåªèµ°ä¸‹é¢get
        const value = this.get();
        if (
          value !== this.value ||
          // Deep watchers and watchers on Object/Arrays should fire even
          // when the value is the same, because the value may
          // have mutated.
          isObject(value) ||
          this.deep
        ) {
          // set new value
          const oldValue = this.value;
          this.value = value;
          if (this.user) {
            try {
              this.cb.call(this.vm, value, oldValue);
            } catch (e) {}
          } else {
            this.cb.call(this.vm, value, oldValue);
          }
        }
      }
    }

    // ä¸ç«‹å³è§¦å‘çš„watcherï¼Œimmediate:false
    evaluate() {
      this.value = this.get();
      this.dirty = false;
    }

    // å’Œ watcher äº’ç›¸å¼•ç”¨
    depend() {
      let i = this.deps.length;
      while (i--) {
        this.deps[i].depend();
      }
    }

    // å–æ¶ˆç›‘å¬ï¼Œå’Œ watcher äº’ç›¸åˆ é™¤ å¼•ç”¨ï¼Œ$watch æ—¶ä½¿ç”¨
    teardown() {
      if (this.active) {
        // remove self from vm's watcher list
        // this is a somewhat expensive operation so we skip it
        // if the vm is being destroyed.
        if (!this.vm._isBeingDestroyed) {
          remove(this.vm._watchers, this);
        }
        let i = this.deps.length;
        while (i--) {
          this.deps[i].removeSub(this);
        }
        this.active = false;
      }
    }
  }
  ```

  &emsp;&emsp;å³ä½¿åªé€‰å–äº† **Watcher** çš„æ ¸å¿ƒæºç ï¼Œä½†å†…å®¹ä¾ç„¶å¾ˆå¤šï¼Œä¸»è¦åŒ…æ‹¬**é‡æ–°æ”¶é›†ä¾èµ–**å’Œ`computed`ã€`watch`ã€`$watch`è¿™äº›è¿‡ç¨‹ï¼Œå¿½ç•¥è¿™äº›æƒ…å†µçš„è¯ï¼Œå…¶å®**Watcher**çš„æ ¸å¿ƒä½œç”¨åªæœ‰**åˆå§‹åŒ–**å’Œ**æ›´æ–°**ã€‚

  &emsp;&emsp;å€¼å¾—æ³¨æ„çš„æ˜¯`get`æ–¹æ³•ï¼Œæœ€ç»ˆçš„**æ¸²æŸ“**å’Œ**æ›´æ–°**éƒ½ä¼šèµ°åˆ°è¿™é‡Œï¼Œå¹¶ä¸”é‡Œé¢æœ‰ä¸€ä¸ª`popTarget`æ–¹æ³•ï¼Œè¿™æ˜¯å®ç°`Vue.set`çš„å…³é”®ã€‚

## Vue.set

&emsp;&emsp;è¯´äº†è¿™ä¹ˆå¤šé`Vue.set`ï¼Œæ˜¯ä¸æ˜¯ä»¥ä¸ºå®ç°èµ·æ¥ä¼šå¾ˆå¤æ‚ï¼Œç›¸å**æ ¸å¿ƒæºç **åªæœ‰ä¸¤è¡Œï¼Œå…¶å®æµç¨‹å¤§éƒ¨åˆ†éƒ½åœ¨**Watcher**ä¸­å®ç°äº†ã€‚

```javascript
function set(target: Array<any> | Object, key: any, val: any): any {
  defineReactive(ob.value, key, val);
  ob.dep.notify();
}
```

&emsp;&emsp;è°ƒç”¨`Vue.set`åï¼Œé¦–å…ˆä¸º`key`åˆ›å»º`dep`ï¼Œç„¶åå–å‡ºå¯¹è±¡èº«ä¸Šçš„`__ob__`é€šçŸ¥æ›´æ–°ï¼Œæ›´æ–°æ—¶æ¥åˆ°**Watcher**ï¼Œä»`update`åˆ°`get`ï¼Œæœ€ç»ˆå…ˆæ‰§è¡Œ`popTarget`ï¼Œå°†å½“å‰çš„**render Watcher**èµ‹å€¼ç»™`Dep.target`ï¼Œç„¶åè°ƒç”¨ç»„ä»¶çš„`render`å‡½æ•°ï¼Œé—´æ¥è§¦å‘`key`çš„`getter`æ–¹æ³•ï¼Œå®Œæˆ**æ”¶é›†ä¾èµ–**å¹¶**æ›´æ–°è§†å›¾**ã€‚

## æµç¨‹æ¢³ç†

1. **Vue**åˆå§‹åŒ–æ—¶è°ƒç”¨`this._init`ï¼Œå…¶ä¸­`initState`æ–¹æ³•ç”¨äºåˆå§‹åŒ–**å“åº”å¼æ•°æ®**
2. é¦–å…ˆå°†`_data`ä»£ç†åˆ°å®ä¾‹ä¸Šï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡`this`è°ƒç”¨ï¼Œç„¶åå¯¹`_data`è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œä¸ºæ¯ä¸ªè¢«è§‚å¯Ÿçš„å¯¹è±¡åˆ›å»º**è§‚å¯Ÿè€…å®ä¾‹**ï¼Œå¹¶æ·»åŠ åˆ°`__ob__`å±æ€§ä¸Š
3. æ¯ä¸ª**key**æ‹¥æœ‰ä¸€ä¸ª**dep**ï¼Œ`getter`æ—¶æ”¶é›†ä¾èµ–ï¼ˆwatcherï¼‰ï¼Œ`setter`æ—¶é€šçŸ¥ä¾èµ–ï¼ˆwatcherï¼‰æ›´æ–°
4. æ¯ä¸ª**å¯¹è±¡**ä¹Ÿæ‹¥æœ‰ä¸€ä¸ª**dep**ï¼Œç”¨äº**æ•°ç»„æ›´æ–°**å’Œå®ç°`Vue.set`
5. å¯¹äºæ•°ç»„é‡‡ç”¨**æ–¹æ³•è¦†ç›–**ï¼Œ**7 ä¸ªæ–¹æ³•**åœ¨æ‰§è¡Œæ—¶æ‰©å±•ä¸€ä¸ªé¢å¤–çš„æ“ä½œï¼Œè§‚å¯Ÿæ–°å¢çš„å…ƒç´ ï¼Œç„¶åè®©æ•°ç»„çš„`__ob__`é€šçŸ¥**watcher**è¿›è¡Œæ›´æ–°

## æ€»ç»“ä¸æ€è€ƒ

1. **dep**å’Œ**watcher** çš„å…³ç³»ä¸ºä»€ä¹ˆè®¾è®¡æˆå¤šå¯¹å¤šï¼Ÿ<br>

   - é¦–å…ˆè¦æ˜ç™½çš„æ¦‚å¿µæ˜¯ï¼Œ**watcher**åŒ…å«**render Watcher**å’Œ**user watcher**ï¼Œ
   - å…¶æ¬¡ï¼Œä¸€ä¸ª**key**æ‹¥æœ‰ä¸€ä¸ª**dep**ï¼Œ
     - ä¸€ä¸ª**key**å¯èƒ½é€šè¿‡**props**ç»‘å®šç»™å¤šä¸ªç»„ä»¶ï¼Œè¿™å°±æœ‰å¤šä¸ª**render Watcher**
     - å¦‚æœåœ¨ç»„ä»¶ä¸­ä½¿ç”¨äº†`computed`ã€`watch`ï¼Œè¿™å°±åˆæ·»åŠ äº†å¤šä¸ª**user Watcher**
     - åˆ°è¿™é‡Œï¼Œ**dep**å’Œ**watcher**æ˜¯ä¸€å¯¹å¤š
   - Vue2 å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œ**render Watcher**çš„æ›´æ–°ç²’åº¦æ˜¯æ•´ä¸ªç»„ä»¶ï¼Œå¯¹äºä¸€ä¸ªç»„ä»¶ï¼Œé€šå¸¸æœ‰å¤šä¸ªå¯ä»¥è§¦å‘æ›´æ–°çš„ `key`ï¼Œåˆå› ä¸ºä¸€ä¸ª**key**æœ‰ä¸€ä¸ª**dep**ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹**dep**å’Œ**watcher**æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»
   - ç»¼åˆä¸Šé¢ä¸¤ç§æƒ…å†µï¼Œ**dep**å’Œ**watcher**è¢«è®¾è®¡æˆ**å¤šå¯¹å¤š**çš„å…³ç³»æ˜¯æœ€åˆé€‚çš„

2. ä¸ºä»€ä¹ˆéœ€è¦`Vue.set`ï¼Œå…¶ä½¿ç”¨åœºæ™¯éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ<br>

   - å­˜åœ¨çš„æ„ä¹‰ï¼šå› ä¸º`Object.defineProperty`æ— æ³•åŠ¨æ€ç›‘å¬ï¼Œå½“å¢åŠ `key`æ—¶éœ€è¦æ‰‹åŠ¨è®¾ç½®æˆå“åº”å¼ã€‚
   - æ³¨æ„ï¼šæ·»åŠ  key çš„è¿™ä¸ªå¯¹è±¡å¿…é¡»æ˜¯å“åº”å¼ ğŸš©ï¼Œå› ä¸º`Vue.set`å…³é”®çš„ä¸€æ­¥æ˜¯å–å‡º**å¯¹è±¡**èº«ä¸Šçš„**dep**è§¦å‘æ›´æ–°å®Œæˆ**æ”¶é›†ä¾èµ–**ï¼Œå¦‚æœå¯¹è±¡ä¸æ˜¯å“åº”å¼æ•°æ®å°±ä¸å­˜åœ¨**dep**ï¼Œå› æ­¤æ— æ³•å®Œæˆ**ä¾èµ–æ”¶é›†**

3. ç»¼åˆ**æ•°æ®å“åº”å¼åŸç†**ï¼Œæ„Ÿè§‰æœ€å¤æ‚çš„éƒ¨åˆ†åœ¨äºå¤„ç† **æ•°ç»„** å’Œ **æ–°å¢ key** çš„æƒ…å†µï¼Œå¤§é‡é€»è¾‘éƒ½åœ¨**Watcher**ä¸­ï¼Œå¯¼è‡´**Watcher**çš„æºç è¯»èµ·æ¥å¾ˆéº»çƒ¦ï¼Œè¿™ä¹Ÿæ˜¯åæ¥**Vue3**ç€é‡ä¼˜åŒ–çš„ä¸€éƒ¨åˆ†ã€‚åç»­ä¸“é—¨æ•´ç†ä¸‹**Vue3**çš„å˜åŒ–ä»¥ä½œå¯¹æ¯” ğŸš©
