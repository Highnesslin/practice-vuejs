# åˆå§‹åŒ–æµç¨‹

ç ”ç©¶æºç çš„ç¬¬ä¸€æ­¥å°±æ˜¯ä»**åˆå§‹åŒ–**å…¥æ‰‹ï¼Œä½†è¿™ä¹Ÿæ˜¯æœ€å®¹æ˜“åŠé€€çš„ä¸€ä¸ªç¯èŠ‚ï¼Œä¸€å¼€å§‹å¯ä»¥å…ˆåœ¨è„‘æµ·ä¸­ç•™ä¸ªå°è±¡ï¼Œå› ä¸ºåç»­çš„æ¯ä¸ªæµç¨‹åŸºæœ¬éƒ½ä¼šå›åˆ°**åˆå§‹åŒ–**çš„æŸä¸ªè¿‡ç¨‹ç»§ç»­æ·±ç©¶ã€‚

ä¸è¿‡å‘¢ï¼Œè¿™æ¯•ç«Ÿæ˜¯ä¸€ç¯‡æ•´ç†æ€§çš„æ–‡ç« ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½è¦å…¨é¢è¦†ç›–ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡é˜…è¯»è¿™éƒ¨åˆ†å¯ä»¥è·³ç€çœ‹ï¼Œç»†èŠ‚ä¸å…³æ³¨ï¼Œç­‰åˆ°æœ€åå†å›æ¥å›é¡¾ã€‚

## ä»æºç æ¢ç©¶æµç¨‹

é¦–å…ˆæ‰¾åˆ°**å…¥å£**ï¼Œ`/src/platforms/web/`

- entry-compiler.js
- entry-runtime-with-compiler.js
- entry-runtime.js
- entry-server-basic-renderer.js
- entry-server-renderer.js

`entry-runtime-with-compiler.js`æ˜¯æœ€å…¨é¢çš„å…¥å£ï¼Œä»è¿™ä¸ªå…¥å£è¿›å…¥ï¼Œå¯ä»¥è·å¾—**è¿è¡Œæ—¶**å’Œ**ç¼–è¯‘å™¨**ä¸¤éƒ¨åˆ†å†…å®¹

### æ³¨å…¥ç¼–è¯‘å™¨ï¼šentry-runtime-with-compiler.js [/src/platforms/web/](https://github.com/vuejs/vue/blob/dev/src/platforms/web/entry-runtime-with-compiler.js)

- 1. è§£æ `template`
- 2. `template`è½¬`render`å‡½æ•°ï¼Œå¹¶æŒ‚è½½åˆ°`options`ä¸Š

è¿™ä¸€æ­¥ä¸»è¦ä½œç”¨æ˜¯è·å¾— `render`ï¼Œé€šå¸¸åœ¨**webpack**ç¯å¢ƒä¸­å¹¶ä¸éœ€è¦è¿™ä¸€æ­¥ï¼Œå› ä¸º**webpack**åœ¨ç¼–è¯‘é˜¶æ®µå€ŸåŠ©**vue-loader**å°±å°†**å•æ–‡ä»¶**ä¸­çš„`template`è½¬æˆäº†`render`å‡½æ•°

### web è¿è¡Œæ—¶ï¼š [/src/platforms/web/runtime/index.js](https://github.com/vuejs/vue/blob/dev/src/platforms/web/runtime/index.js)

- 1. å®ç°`$mount`
- 2. æŒ‚è½½`__patch__`

è¿™ä¸¤ä¸ªæ–¹æ³•å’Œ **æŒ‚è½½** æ¯æ¯ç›¸å…³ï¼Œåœ¨åç»­çš„åˆå§‹åŒ–ä¸æ›´æ–°æµç¨‹ä¼šæ¥åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

### å®šä¹‰å…¨å±€ APIï¼šinitGlobalAPI [/src/core/index.js](https://github.com/vuejs/vue/blob/dev/src/core/global-api/index.js#L21)

- ä½œç”¨ï¼šåˆå§‹åŒ– Vue çš„é™æ€æ–¹æ³•ï¼Œ
  - **Vue.util** ä¸­çš„æ–¹æ³•ï¼ˆ`mergeOptions`ï¼Œ`defineReactive`ï¼‰ã€
  - `Vue.observe`ã€
  - `Vue.use`ã€
  - `Vue.mixin`ã€
  - `Vue.extend`ã€
  - `Vue.component/directive/filter`
- æ ¸å¿ƒæºç 
  ```javascript
  Vue.set = set;
  Vue.delete = del;
  Vue.nextTick = nextTick;
  initUse(Vue); // å®ç°Vue.useå‡½æ•°
  initMixin(Vue); // å®ç°Vue.mixinå‡½æ•°
  initExtend(Vue); // å®ç°Vue.extendå‡½æ•°
  initAssetRegisters(Vue); // æ³¨å†Œå®ç°Vue.component/directive/filter
  ```

### å…¥å£ï¼š [src/core/instance/index.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/index.js)

- ä½œç”¨
  - 1. å®šä¹‰**Vue**æ„é€ å™¨ï¼Œ
  - 2. ä¸º**Vue**å®ä¾‹æ³¨å…¥`API`
- æ ¸å¿ƒæºç 

  ```javascript
  function Vue(options) {
    this._init(options);
  }

  initMixin(Vue); // åˆå§‹åŒ– this._init æ–¹æ³•
  // å…¶ä»–å®ä¾‹å±æ€§å’Œæ–¹æ³•ç”±ä¸‹é¢è¿™äº›æ–¹æ³•æ··å…¥
  stateMixin(Vue);
  eventsMixin(Vue);
  lifecycleMixin(Vue);
  renderMixin(Vue);
  ```

  æˆ‘ä»¬ç†ŸçŸ¥çš„**å®ä¾‹æ–¹æ³•**åŸºæœ¬éƒ½æ¥è‡ªè¿™é‡Œ

  1. stateMixin
     å®šä¹‰`$data`ã€`$props`ã€`$set`ã€`$delete`ã€`$watch`
  2. eventsMixin
     å®šä¹‰`$on`ã€`emit`ã€`off`ã€`once`
  3. lifecycleMixin
     å®šä¹‰`_update`ã€`$forceUpdate`ã€`$destory`
  4. renderMixin
     å®šä¹‰`$nextTick`ã€`_render`

     ä¸ºå®ä¾‹æ³¨å…¥æ–¹æ³•ï¼ŒåŸºæœ¬å¹³æ—¶å·¥ä½œç”¨éƒ½æœ‰æ‰€æ¶‰åŠï¼Œä¸ªäººæ„Ÿè§‰éå¸¸éå¸¸é‡è¦

### this.\_init [src/core/instance/init.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/init.js#L16)

- ä½œç”¨

  - è°ƒç”¨ `mergeOptions` åˆå¹¶ `Vue.options` å’Œ `new Vue`ä¼ å…¥çš„å‚æ•°ï¼Œèµ‹å€¼ç»™`vm.$options`
  - ä¼´éšç€ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œï¼Œä¸º**å®ä¾‹**æ·»åŠ å±æ€§ã€æ·»åŠ äº‹ä»¶ç›‘å¬ï¼ˆç»„ä»¶é€šä¿¡ï¼‰ã€åˆå§‹åŒ–æ¸²æŸ“ç›¸å…³ã€æ‰§è¡Œæ•°æ®å“åº”å¼ç­‰ç­‰ï¼Œæœ€åè°ƒç”¨`$mount`å°†ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢

- æ ¸å¿ƒæºç 

  ```javascript
  vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || {}, vm);
  initLifecycle(vm); // å®ä¾‹å±æ€§ï¼š$parent,$root,$children,$refs
  initEvents(vm); // ç›‘å¬_parentListeners
  initRender(vm); // æ’æ§½è§£æï¼Œ$slots,$scopeSlots,  $createElement()
  callHook(vm, 'beforeCreate');
  // æ¥ä¸‹æ¥éƒ½æ˜¯å’Œç»„ä»¶çŠ¶æ€ç›¸å…³çš„æ•°æ®æ“ä½œ
  // inject/provide
  initInjections(vm); // æ³¨å…¥ç¥–è¾ˆä¼ é€’ä¸‹æ¥çš„æ•°æ®
  initState(vm); // æ•°æ®å“åº”å¼ï¼šprops,methods,data,computed,watch
  initProvide(vm); // æä¾›ç»™åä»£ï¼Œç”¨æ¥éš”ä»£ä¼ é€’å‚æ•°
  callHook(vm, 'created');

  // å¦‚æœè®¾ç½®äº† elï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œ$mount()
  if (vm.$options.el) {
    vm.$mount(vm.$options.el);
  }
  ```

  æˆ‘ä»¬ç†ŸçŸ¥çš„**å®ä¾‹æ–¹æ³•**åŸºæœ¬éƒ½æ¥è‡ªè¿™é‡Œ

  1. initLifecycle
     å®šä¹‰`vm.$parent`ã€`vm.$root`ã€`vm.$refs`ã€`vm.$children`
  2. initEvents
     å®šä¹‰`vm._events`ã€`updateComponentListeners(vm.$listeners)`
  3. initRender
     å®šä¹‰`vm._c`ã€`vm.$createElement`
  4. initInjections
     ä¾æ¬¡æ‰§è¡Œ`resolveInject`ã€`defineReactive`
  5. initState
     å®šä¹‰`initProps`ã€`initMethods`ã€`initData`ã€`initComputed`ã€`initWatch`
  6. initProvide
     å®šä¹‰`vm._provide`

     åŒæ ·ä¹Ÿæ˜¯å®šä¹‰**å®ä¾‹**ä¸Šçš„å±æ€§ï¼Œä¸ä¹‹ä¸åŒçš„æ˜¯ï¼Œä¸Šä¸ªè¿‡ç¨‹å®šä¹‰çš„**api**å¤§å¤šæ˜¯å¹³æ—¶å·¥ä½œå†™ä¸šåŠ¡ç”¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯ä¸ºåç»­æä¾›äº†æ–¹æ³•çš„å®šä¹‰ï¼Œå¦å¤–`initLifecycle`ä¸­å®šä¹‰çš„å±æ€§å¹³æ—¶å†™**ç»„ä»¶åº“**çš„è¯å¾ˆç†Ÿæ‚‰ã€‚

### æ¸²æŸ“çš„å…¥å£ï¼š$mount

å¼€å¤´å·²æœ‰ä»‹ç»ï¼Œç°åœ¨æ˜¯è¯¦ç»†æ¢ç©¶ï¼Œåˆ†å¼€æ•´ç†çš„åŸå› æ˜¯ï¼Œ`$mount`å¹¶ä¸æ˜¯ä¸€æ¬¡ç®€å•çš„å£°æ˜ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å¤šæ¬¡æ–¹æ³•è¦†ç›–ï¼Œå½“åˆç¬¬ä¸€æ¬¡çœ‹æºç å·®ç‚¹ç»•è¿›å»ï¼Œè¿™é‡Œç‰¹æ„åšä¸ªæé†’ ğŸš©

#### ç¼–è¯‘ç›¸å…³ [/src/platforms/web/entry-runtime-with-compiler.js](https://github.com/vuejs/vue/blob/dev/src/platforms/web/entry-runtime-with-compiler.js#L18)

è¯¥æ–‡ä»¶ä½äº **platforms** ä¸‹çš„ **web** æ¨¡å—ï¼Œåç§°ä¸º`entry-runtime-with-compiler`ï¼Œæ„å‘³ç€è¿™æ˜¯ä¸€ä¸ªå¸¦ç€ç¼–è¯‘å™¨çš„è¿è¡Œæ–‡ä»¶ã€‚

- ä½œç”¨
  - å°† `template` è½¬æˆ **render å‡½æ•°**
- æ ¸å¿ƒæºç 
  ```javascript
  if (!options.render) {
    // å…ˆç»è¿‡ å¤šæ ¹/domå’Œå­—ç¬¦ä¸²æƒ…å†µ çš„å¤„ç†ï¼Œå˜æˆå•æ ¹çš„å­—ç¬¦ä¸²å½¢å¼
    // ...
    if (template) {
      const { render, staticRenderFns } = compileToFunctions(
        template,
        {
          outputSourceRange: process.env.NODE_ENV !== 'production',
          shouldDecodeNewlines,
          shouldDecodeNewlinesForHref,
          delimiters: options.delimiters,
          comments: options.comments,
        },
        this
      );
    }
  }
  return mount.call(this, el, hydrating);
  ```
  `template` æœ‰ä¸¤ç§æƒ…å†µï¼Œ`å­—ç¬¦ä¸²`æˆ– `domé€‰æ‹©å™¨`ï¼Œä½†æœ€ç»ˆéƒ½ä¼šå¤„ç†æˆå­—ç¬¦ä¸²ï¼Œå¦‚æœ `template` æ˜¯å¤šæ ¹å…ƒç´ ï¼Œç»è¿‡`compileToFunctions`å¤„ç†åªä¿ç•™ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯ `template` å¿…é¡»è¦ç”¨å•æ ¹çš„åŸå› 

#### æ¸²æŸ“ç›¸å…³ [/src/platforms/web/runtime/index.js](https://github.com/vuejs/vue/blob/dev/src/platforms/web/runtime/index.js#L37)

- ä½œç”¨ï¼š
  - 1. å®šä¹‰**patch**ï¼šç”¨äºæ‰§è¡Œ **patching** ç®—æ³•è¿›è¡Œæ›´æ–°
  - 2. ä¸º`$mount`é¢å¤–æ·»åŠ `mountComponent`ï¼Œç”¨äºåœ¨**web å¹³å°** **æ‰§è¡ŒæŒ‚è½½**
- æ ¸å¿ƒæºç 

  ```javascript
  Vue.prototype.__patch__ = inBrowser ? patch : noop;

  Vue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {
    el = el && inBrowser ? query(el) : undefined;
    return mountComponent(this, el, hydrating);
  };
  ```

#### æ¸²æŸ“é˜¶æ®µçš„å…¥å£ï¼šmountComponent [/src/core/instance/lifecycle.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/lifecycle.js#L141)

- ä½œç”¨ï¼šç»„ä»¶åˆå§‹åŒ–å’Œæ›´æ–°æœ€é‡è¦çš„æµç¨‹ä¹‹ä¸€ï¼Œç»™`updateComponent`èµ‹å€¼**æ›´æ–°å‡½æ•°**ï¼Œåˆ›å»º**Watcher**
- æ ¸å¿ƒæºç 

  ```javascript
  if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
    // ...
  } else {
    updateComponent = () => {
      vm._update(vm._render(), hydrating);
    };
  }

  // we set this to vm._watcher inside the watcher's constructor
  // since the watcher's initial patch may call $forceUpdate (e.g. inside child
  // component's mounted hook), which relies on vm._watcher being already defined
  new Watcher(
    vm,
    updateComponent,
    noop,
    {
      before() {
        if (vm._isMounted && !vm._isDestroyed) {
          callHook(vm, 'beforeUpdate');
        }
      },
    },
    true /* isRenderWatcher */
  );
  ```

  **Watcher**åˆ†ä¸º**render Watcher**å’Œ**user Watcher**<br>
  åœ¨ Vue ä¸­ï¼Œæ‰€æœ‰çš„æ¸²æŸ“éƒ½ç”± **render Watcher** å®Œæˆï¼ŒåŒ…æ‹¬åˆå§‹åŒ–æ¸²æŸ“å’Œåç»­çš„ç»„ä»¶æ›´æ–°ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ç»“æŸåï¼Œç»„ä»¶ä¼šåœ¨é¡µé¢ä¸Šå®Œæˆæ›´æ–°ï¼Œ

## æµç¨‹æ¢³ç†

1. é¦–å…ˆåˆå§‹åŒ–**å…¨å±€**çš„é™æ€æ–¹æ³•ï¼Œcomponentsã€filterã€directiveã€‚setã€delete ç­‰ï¼Œ
2. ç„¶åå®šä¹‰**Vue å®ä¾‹**çš„æ–¹æ³•ï¼Œ
3. æ¥ç€æ‰§è¡Œ`init`æ–¹æ³•è¿›è¡Œ**å®ä¾‹**çš„åˆå§‹åŒ–ï¼Œä¼´éšç€**ç”Ÿå‘½å‘¨æœŸ**çš„è¿›è¡Œæ‰§è¡Œåˆå§‹åŒ–å±æ€§ã€äº‹ä»¶ç›‘å¬ã€æ•°æ®å“åº”å¼ï¼Œæœ€åè°ƒç”¨`$mount`å°†ç»„ä»¶æŒ‚è½½åˆ°é¡µé¢ä¸Š

## æ€»ç»“ä¸æ€è€ƒ

1. ä¸ºä»€ä¹ˆæå¾—å¦‚æ­¤å¤æ‚ï¼Ÿ<br>
   å¤§éƒ¨åˆ†å¤æ‚çš„æµç¨‹éƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿è·¨å¹³å°ï¼Œå› ä¸º**Vue2**æ–°å¢äº†è·¨ç«¯å¼€å‘çš„**Weex**ï¼Œæ‰€ä»¥éœ€è¦æ³¨å…¥å¹³å°ç‰¹æœ‰çš„æ–¹æ³•
2. åœ¨`mergeOptions`ä¸­å‘ç°æœ‰ä¸ªç›‘å¬äº‹ä»¶ç»‘å®šçš„æ“ä½œç”¨äºç»„ä»¶é€šä¿¡æ—¶ï¼Œå…¶é€šä¿¡æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ<br/>
   å½“å‰ç»„ä»¶åœ¨`mergeOptions`æ—¶æœ‰ä¸€ä¸ªå±æ€§`parentListener`ç”¨æ¥å­˜æ”¾çˆ¶ç»„ä»¶é€šè¿‡ props ç»‘å®šçš„äº‹ä»¶ï¼Œç»„ä»¶ä¼šé€šè¿‡`$on`å°†æ³¨å†Œåˆ°è‡ªèº«ï¼Œåœ¨ä½¿ç”¨æ—¶ç›´æ¥`$emit`è§¦å‘å³å¯

3. ç”Ÿå‘½å‘¨æœŸçš„åç§°åŠåº”ç”¨ï¼š

   - 2.1. åˆ†ç±»åˆ—ä¸¾

     - åˆå§‹åŒ–é˜¶æ®µï¼šbeforeCreateã€createdã€beforeMountã€mounted
     - æ›´æ–°é˜¶æ®µï¼šbeforeUpdateã€updated
     - é”€æ¯é˜¶æ®µï¼šbeforeDestroyã€destroyed

   - 2.2. åº”ç”¨ï¼š

     - created æ—¶ï¼Œæ‰€æœ‰æ•°æ®å‡†å¤‡å°±ç»ªï¼Œé€‚åˆåšæ•°æ®è·å–ã€èµ‹å€¼ç­‰æ•°æ®æ“ä½œ
     - mounted æ—¶ï¼Œ$el å·²ç”Ÿæˆï¼Œå¯ä»¥è·å– domï¼›å­ç»„ä»¶ä¹Ÿå·²æŒ‚è½½ï¼Œå¯ä»¥è®¿é—®å®ƒä»¬
     - updated æ—¶ï¼Œæ•°å€¼å˜åŒ–å·²ä½œç”¨äº domï¼Œå¯ä»¥è·å– dom æœ€æ–°çŠ¶æ€
     - destroyed æ—¶ï¼Œç»„ä»¶å®ä¾‹å·²é”€æ¯ï¼Œé€‚åˆå–æ¶ˆå®šæ—¶å™¨ç­‰æ“ä½œ
