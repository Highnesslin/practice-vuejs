# åˆå§‹åŒ–æµç¨‹

## ä»æºç æ¢ç©¶æµç¨‹

### initGlobalAPI [/src/core/index.js](https://github.com/vuejs/vue/blob/dev/src/core/global-api/index.js#L21)

- ä½œç”¨ï¼šåˆå§‹åŒ– Vue çš„é™æ€æ–¹æ³•ï¼ŒåŒ…æ‹¬ **Vue.util** ä¸­çš„æ–¹æ³•ï¼ˆ`mergeOptions`ï¼Œ`defineReactive`ï¼‰ã€`Vue.component`ã€`Vue.observe`ã€`Vue.use`ã€`Vue.mixin`ã€`Vue.extend`ã€`Vue.component/directive/filter`ï¼Œè¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Œåç»­çš„å¾ˆå¤šæ–¹æ³•éƒ½æ¥è‡ªè¿™é‡Œï¼Œæ¯”å¦‚**ç»„ä»¶åŒ–åŸç†**
- æ ¸å¿ƒæºç 
  ```javascript
  Vue.set = set;
  Vue.delete = del;
  Vue.nextTick = nextTick;
  initUse(Vue); // å®ç°Vue.useå‡½æ•°
  initMixin(Vue); // å®ç°Vue.mixinå‡½æ•°
  initExtend(Vue); // å®ç°Vue.extendå‡½æ•°
  initAssetRegisters(Vue); // æ³¨å†Œå®ç°Vue.component/directive/filter
  ```

### å…¥å£ï¼š [src/core/instance/index.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/index.js)

- ä½œç”¨ï¼šå®šä¹‰**Vue**æ„é€ å™¨ï¼Œ**Vue**å®ä¾‹`API`
- æ ¸å¿ƒæºç 

  ```javascript
  function Vue(options) {
    this._init(options);
  }

  initMixin(Vue); // åˆå§‹åŒ– this._init æ–¹æ³•
  // å…¶ä»–å®ä¾‹å±æ€§å’Œæ–¹æ³•ç”±ä¸‹é¢è¿™äº›æ–¹æ³•æ··å…¥
  stateMixin(Vue);
  eventsMixin(Vue);
  lifecycleMixin(Vue);
  renderMixin(Vue);
  ```

### this.\_init [src/core/instance/init.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/init.js#L16)

- ä½œç”¨

  - è°ƒç”¨ `mergeOptions` åˆå¹¶ `new Vue` ä¼ å…¥çš„å‚æ•° å’Œ `Vue.options` åˆ°ç»„ä»¶`vm.$options`
  - ä¼´éšç€ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œï¼Œç»™**å®ä¾‹**æ·»åŠ å±æ€§ã€æ·»åŠ äº‹ä»¶ç›‘å¬ï¼ˆç»„ä»¶é€šä¿¡ï¼‰ã€åˆå§‹åŒ–æ¸²æŸ“ç›¸å…³ã€æ•°æ®å“åº”å¼ç­‰ç­‰ï¼Œæœ€åè°ƒç”¨`$mount`å°†ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢

- æ ¸å¿ƒæºç 

  ```javascript
  vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || {}, vm);
  initLifecycle(vm); // å®ä¾‹å±æ€§ï¼š$parent,$root,$children,$refs
  initEvents(vm); // ç›‘å¬_parentListeners
  initRender(vm); // æ’æ§½è§£æï¼Œ$slots,$scopeSlots,  $createElement()
  callHook(vm, 'beforeCreate');
  // æ¥ä¸‹æ¥éƒ½æ˜¯å’Œç»„ä»¶çŠ¶æ€ç›¸å…³çš„æ•°æ®æ“ä½œ
  // inject/provide
  initInjections(vm); // æ³¨å…¥ç¥–è¾ˆä¼ é€’ä¸‹æ¥çš„æ•°æ®
  initState(vm); // æ•°æ®å“åº”å¼ï¼šprops,methods,data,computed,watch
  initProvide(vm); // æä¾›ç»™åä»£ï¼Œç”¨æ¥éš”ä»£ä¼ é€’å‚æ•°
  callHook(vm, 'created');

  // å¦‚æœè®¾ç½®äº† elï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œ$mount()
  if (vm.$options.el) {
    vm.$mount(vm.$options.el);
  }
  ```

### $mount ğŸš©

è¿™é‡Œåˆ†å¼€æ•´ç†çš„åŸå› æ˜¯ï¼Œ`$mount`å¹¶ä¸æ˜¯ä¸€æ¬¡ç®€å•çš„å£°æ˜ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å¤šæ¬¡æ–¹æ³•è¦†ç›–ï¼Œå½“åˆç¬¬ä¸€æ¬¡çœ‹æºç å·®ç‚¹ç»•è¿›å»ï¼Œè¿™é‡Œç‰¹æ„åšä¸ªæé†’ ğŸš©

#### è¯ç”Ÿçš„ç¬¬ä¸€æ­¥ [/src/platforms/web/entry-runtime-with-compiler.js](https://github.com/vuejs/vue/blob/dev/src/platforms/web/entry-runtime-with-compiler.js#L18)

è¯¥æ–‡ä»¶ä½äº **platforms** ä¸‹çš„ **web** æ¨¡å—ï¼Œåç§°ä¸º`entry-runtime-with-compiler`ï¼Œæ„å‘³ç€è¿™æ˜¯ä¸€ä¸ªå¸¦ç€ç¼–è¯‘å™¨çš„è¿è¡Œæ–‡ä»¶ï¼Œ

- ä½œç”¨
  - å°† template è½¬æˆ render å‡½æ•°ï¼Œtemplate æœ‰ä¸¤ç§æƒ…å†µï¼Œ`å­—ç¬¦ä¸²`æˆ– `domé€‰æ‹©å™¨`ï¼Œä½†æœ€ç»ˆéƒ½ä¼šå¤„ç†æˆå­—ç¬¦ä¸²ï¼Œå¦‚æœ template æ˜¯å¤šæ ¹å…ƒç´ ï¼Œç»è¿‡`compileToFunctions`å¤„ç†åªä¿ç•™ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯åœ¨ Vue2 ä¸­ template å¿…é¡»è¦ç”¨å•æ ¹çš„åŸå› 
- æ ¸å¿ƒæºç 
  ```javascript
  if (!options.render) {
    // å…ˆç»è¿‡ å¤šæ ¹/domå’Œå­—ç¬¦ä¸²æƒ…å†µ çš„å¤„ç†ï¼Œå˜æˆå•æ ¹çš„å­—ç¬¦ä¸²å½¢å¼
    // ...
    if (template) {
      const { render, staticRenderFns } = compileToFunctions(
        template,
        {
          outputSourceRange: process.env.NODE_ENV !== 'production',
          shouldDecodeNewlines,
          shouldDecodeNewlinesForHref,
          delimiters: options.delimiters,
          comments: options.comments,
        },
        this
      );
    }
  }
  return mount.call(this, el, hydrating);
  ```

#### ç¬¬äºŒæ­¥ [/src/platforms/web/runtime/index.js](https://github.com/vuejs/vue/blob/dev/src/platforms/web/runtime/index.js#L37)

- ä½œç”¨ï¼š
  - 1. å®šä¹‰**patch**ï¼šç”¨äºæ‰§è¡Œ **patching** ç®—æ³•è¿›è¡Œæ›´æ–°
  - 2. è®©`$mount`é¢å¤–æ·»åŠ ä¸€ä¸ª**web å¹³å°** **æŒ‚è½½ç»„ä»¶**çš„æ–¹æ³•
- æ ¸å¿ƒæºç 

```javascript
Vue.prototype.__patch__ = inBrowser ? patch : noop;

Vue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {
  el = el && inBrowser ? query(el) : undefined;
  return mountComponent(this, el, hydrating);
};
```

#### æ¸²æŸ“é˜¶æ®µçš„å…¥å£ï¼šmountComponent [/src/core/instance/lifecycle.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/lifecycle.js#L141)

- ä½œç”¨ï¼šç»„ä»¶åˆå§‹åŒ–å’Œæ›´æ–°æœ€é‡è¦çš„æµç¨‹ä¹‹ä¸€ï¼Œç»™`updateComponent`èµ‹å€¼**æ›´æ–°å‡½æ•°**ï¼Œåˆ›å»º**render Watcher(Watcher åˆ†ä¸º render Watcher å’Œ user Watcher)**
- æ ¸å¿ƒæºç 

  ```javascript
  if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
    // ...
  } else {
    updateComponent = () => {
      vm._update(vm._render(), hydrating);
    };
  }

  // we set this to vm._watcher inside the watcher's constructor
  // since the watcher's initial patch may call $forceUpdate (e.g. inside child
  // component's mounted hook), which relies on vm._watcher being already defined
  new Watcher(
    vm,
    updateComponent,
    noop,
    {
      before() {
        if (vm._isMounted && !vm._isDestroyed) {
          callHook(vm, 'beforeUpdate');
        }
      },
    },
    true /* isRenderWatcher */
  );
  ```

åœ¨ Vue ä¸­ï¼Œæ‰€æœ‰çš„æ¸²æŸ“éƒ½ç”± Watcher å®Œæˆï¼ŒåŒ…æ‹¬åˆå§‹åŒ–æ¸²æŸ“å’Œåç»­çš„ç»„ä»¶æ›´æ–°ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ç»“æŸåï¼Œç»„ä»¶ä¼šåœ¨é¡µé¢ä¸Šå®Œæˆæ›´æ–°ï¼Œ

## æ€»ç»“ä¸æ€è€ƒ

1. æ•´ä½“æµç¨‹é¢„è§ˆï¼šé¦–å…ˆåˆå§‹åŒ–**å…¨å±€**çš„é™æ€æ–¹æ³•ï¼Œcomponentsã€filterã€directiveã€‚setã€delete ç­‰ï¼Œç„¶åå®šä¹‰**Vue å®ä¾‹**çš„æ–¹æ³•ï¼Œæ¥ç€æ‰§è¡Œ`init`æ–¹æ³•è¿›è¡Œ**å®ä¾‹**çš„åˆå§‹åŒ–ï¼Œä¼´éšç€ç”Ÿå‘½å‘¨æœŸçš„è¿›è¡Œåˆ†åˆ«æ‰§è¡Œåˆšåˆšå±æ€§å®šä¹‰ï¼Œäº‹ä»¶ç›‘å¬ï¼Œæ•°æ®å“åº”å¼ï¼Œæœ€åæ‰§è¡Œ`$mount`å°†ç»„ä»¶æŒ‚è½½åˆ°é¡µé¢ä¸Š

2. åœ¨`mergeOptions`ä¸­å‘ç°æœ‰ä¸ªç›‘å¬äº‹ä»¶ç»‘å®šçš„æ“ä½œç”¨äºç»„ä»¶é€šä¿¡æ—¶ï¼Œå…¶é€šä¿¡æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ<br/>
   å½“å‰ç»„ä»¶åœ¨`mergeOptions`æ—¶æœ‰ä¸€ä¸ªå±æ€§`parentListener`ç”¨æ¥å­˜æ”¾çˆ¶ç»„ä»¶é€šè¿‡ props ç»‘å®šçš„äº‹ä»¶ï¼Œç»„ä»¶ä¼šé€šè¿‡`$on`å°†æ³¨å†Œåˆ°è‡ªèº«ï¼Œåœ¨ä½¿ç”¨æ—¶ç›´æ¥`$emit`è§¦å‘å³å¯

3. ç”Ÿå‘½å‘¨æœŸçš„åç§°åŠåº”ç”¨ï¼š

   - 3.1. åˆ†ç±»åˆ—ä¸¾

     - åˆå§‹åŒ–é˜¶æ®µï¼šbeforeCreateã€createdã€beforeMountã€mounted
     - æ›´æ–°é˜¶æ®µï¼šbeforeUpdateã€updated
     - é”€æ¯é˜¶æ®µï¼šbeforeDestroyã€destroyed

   - 3.2. åº”ç”¨ï¼š

     - created æ—¶ï¼Œæ‰€æœ‰æ•°æ®å‡†å¤‡å°±ç»ªï¼Œé€‚åˆåšæ•°æ®è·å–ã€èµ‹å€¼ç­‰æ•°æ®æ“ä½œ
     - mounted æ—¶ï¼Œ$el å·²ç”Ÿæˆï¼Œå¯ä»¥è·å– domï¼›å­ç»„ä»¶ä¹Ÿå·²æŒ‚è½½ï¼Œå¯ä»¥è®¿é—®å®ƒä»¬
     - updated æ—¶ï¼Œæ•°å€¼å˜åŒ–å·²ä½œç”¨äº domï¼Œå¯ä»¥è·å– dom æœ€æ–°çŠ¶æ€
     - destroyed æ—¶ï¼Œç»„ä»¶å®ä¾‹å·²é”€æ¯ï¼Œé€‚åˆå–æ¶ˆå®šæ—¶å™¨ç­‰æ“ä½œ
