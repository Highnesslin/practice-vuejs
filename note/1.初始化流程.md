# åˆå§‹åŒ–æµç¨‹

&emsp;&emsp;ç ”ç©¶æºç çš„ç¬¬ä¸€æ­¥å°±æ˜¯ä»**åˆå§‹åŒ–**å…¥æ‰‹ï¼Œè¿™ä¸ªé˜¶æ®µçš„å†…å®¹å¤§å¤šéƒ½å¾ˆæŠ½è±¡ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“å°†æ¥æœ‰ä»€ä¹ˆå…·ä½“ä½œç”¨ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æœ€å®¹æ˜“åŠé€€çš„ä¸€ä¸ªç¯èŠ‚ã€‚å¯ä»¥å…ˆåœ¨è„‘æµ·ä¸­ç•™ä¸ªå°è±¡ï¼Œåç»­å¾ˆå¤šæµç¨‹éƒ½ä¼šå›åˆ°**è¿™é‡Œ**çš„æŸä¸ªæ–¹æ³•ç»§ç»­æ·±ç©¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸æ–­åŠ æ·±è®°å¿†ã€‚

&emsp;&emsp;æ‰€è°“åˆå§‹åŒ–ï¼Œå°±æ˜¯**Vue**ä»æ— åˆ°æœ‰çš„è¿‡ç¨‹ï¼Œå…ˆåç»å†**å®šä¹‰ Vue çš„å…¨å±€å±æ€§åŠæ–¹æ³•**ã€**åˆ›å»ºå®ä¾‹ã€å®šä¹‰å®ä¾‹çš„å±æ€§åŠæ–¹æ³•**ã€**æ‰§è¡Œæ•°æ®å“åº”å¼**ã€**æŒ‚è½½ dom**

## ä»æºç æ¢ç©¶æµç¨‹

é¦–å…ˆæ‰¾åˆ°**å…¥å£æ–‡ä»¶å¤¹**ï¼Œ`/src/platforms/web/`ï¼Œå¯ä»¥çœ‹åˆ°å¤šä¸ªå…¥å£æ–‡ä»¶

- entry-compiler.js
- entry-runtime-with-compiler.js
- entry-runtime.js
- entry-server-basic-renderer.js
- entry-server-renderer.js

ä»`entry-runtime-with-compiler.js`è¿›å…¥ï¼Œå¯ä»¥è·å¾—æœ€å…¨é¢çš„å†…å®¹ï¼ŒåŒ…æ‹¬**è¿è¡Œæ—¶**å’Œ**ç¼–è¯‘å™¨**ä¸¤å¤§éƒ¨åˆ†

### æ³¨å…¥ç¼–è¯‘å™¨ï¼šentry-runtime-with-compiler.js [/src/platforms/web/](https://github.com/vuejs/vue/blob/dev/src/platforms/web/entry-runtime-with-compiler.js#L18)

- ä½œç”¨
  - ä¸º**Vue**å®ä¾‹ä¸Šçš„`$mount`æ–¹æ³•æ³¨å…¥**ç¼–è¯‘å™¨**ï¼Œè¯¥**ç¼–è¯‘å™¨**çš„ä½œç”¨æ˜¯å°† **template** è½¬æˆ **render å‡½æ•°**
- æ ¸å¿ƒæºç 

  ```javascript
  if (!options.render) {
    // å…ˆç»è¿‡ å¤šæ ¹/domå’Œå­—ç¬¦ä¸²æƒ…å†µ çš„å¤„ç†ï¼Œå˜æˆå•æ ¹çš„å­—ç¬¦ä¸²å½¢å¼
    // ...
    if (template) {
      const { render, staticRenderFns } = compileToFunctions(
        template,
        {
          outputSourceRange: process.env.NODE_ENV !== 'production',
          shouldDecodeNewlines,
          shouldDecodeNewlinesForHref,
          delimiters: options.delimiters,
          comments: options.comments,
        },
        this
      );
      options.render = render;
    }
  }
  return mount.call(this, el, hydrating);
  ```

  &emsp;&emsp;`template` æœ‰ä¸¤ç§æƒ…å†µï¼Œ`å­—ç¬¦ä¸²`æˆ– `domé€‰æ‹©å™¨`ï¼Œä½†æœ€ç»ˆéƒ½ä¼šå¤„ç†æˆå­—ç¬¦ä¸²ï¼Œå¦‚æœ `template` æ˜¯å¤šæ ¹å…ƒç´ ï¼Œç»è¿‡`compileToFunctions`å¤„ç†åªä¿ç•™ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯ `template` å¿…é¡»è¦ç”¨å•æ ¹çš„åŸå› 

  &emsp;&emsp;è¿™ä¸€æ­¥çš„**å…³é”®**æ˜¯è·å¾—`render`å‡½æ•°ï¼Œåç»­çš„**ç»„ä»¶æ¸²æŸ“**å’Œ**æ›´æ–°**éƒ½ä¼šç”¨åˆ°è¿™ä¸ªæ–¹æ³•ã€‚é€šå¸¸åœ¨**webpack**ç¯å¢ƒä¸­å¹¶ä¸éœ€è¦**æ³¨å…¥ç¼–è¯‘å™¨**è¿™ä¸€æ­¥ï¼Œå› ä¸º**webpack**åœ¨ç¼–è¯‘é˜¶æ®µå€ŸåŠ©**vue-loader**å°†**å•æ–‡ä»¶**ä¸­çš„`template`è½¬æˆ`render`å‡½æ•°ï¼Œä»è€Œå‡å°‘**ç”Ÿäº§ç¯å¢ƒ**ä¸‹**Vue**æ–‡ä»¶çš„ä½“ç§¯å’Œç¼–è¯‘çš„æ—¶é—´ã€‚

### æ³¨å…¥ web è¿è¡Œæ—¶ï¼š [/src/platforms/web/runtime/index.js](https://github.com/vuejs/vue/blob/dev/src/platforms/web/runtime/index.js)

æ‰€è°“ **web è¿è¡Œæ—¶**ï¼Œå…¶å®å°±æ˜¯æ³¨å…¥ **web å¹³å°** ç‰¹æœ‰çš„æ–¹æ³•ï¼Œå› ä¸ºè¿˜è¦è€ƒè™‘**Weex**ï¼Œæ‰€ä»¥å•ç‹¬åˆ†å‡ºäº†è¿™ä¸ªæ¨¡å—

- ä½œç”¨ï¼š
  - ä¸ºå®ä¾‹å®šä¹‰**patch**æ–¹æ³•ï¼Œç”¨äº **ç»„ä»¶æ›´æ–°**
  - ä¸ºå®ä¾‹ä¸Šçš„`$mount`æ–¹æ³•é¢å¤–æ‰©å±•`mountComponent`æ–¹æ³•ï¼Œç”¨äº**å°†ç»„ä»¶æ¸²æŸ“åˆ°æµè§ˆå™¨**
- æ ¸å¿ƒæºç 

  ```javascript
  Vue.prototype.__patch__ = inBrowser ? patch : noop;

  Vue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {
    el = el && inBrowser ? query(el) : undefined;
    return mountComponent(this, el, hydrating);
  };
  ```

  ä¸º**å®ä¾‹**æ·»åŠ çš„è¿™ä¸¤ä¸ªæ–¹æ³•å’Œ **æŒ‚è½½** æ¯æ¯ç›¸å…³ï¼Œåœ¨åç»­çš„**åˆå§‹åŒ–**ä¸**æ›´æ–°æµç¨‹**ä¼šç”¨åˆ°ã€‚

### å®šä¹‰å…¨å±€ APIï¼šinitGlobalAPI [/src/core/index.js](https://github.com/vuejs/vue/blob/dev/src/core/global-api/index.js#L21)

- ä½œç”¨ï¼šåˆå§‹åŒ– Vue çš„é™æ€æ–¹æ³•ï¼Œ
  - **Vue.util** ä¸­çš„æ–¹æ³•ï¼ˆ`mergeOptions`ï¼Œ`defineReactive`ï¼‰ã€
  - `Vue.observe`ã€
  - `Vue.use`ã€
  - `Vue.mixin`ã€
  - `Vue.extend`ã€
  - `Vue.component/directive/filter`
- æ ¸å¿ƒæºç 

  ```javascript
  Vue.set = set;
  Vue.delete = del;
  Vue.nextTick = nextTick;
  initUse(Vue); // å®ç°Vue.useå‡½æ•°
  initMixin(Vue); // å®ç°Vue.mixinå‡½æ•°
  initExtend(Vue); // å®ç°Vue.extendå‡½æ•°
  initAssetRegisters(Vue); // æ³¨å†Œå®ç°Vue.component/directive/filter
  ```

  è¿™ä¸€æ­¥æ˜¯æ³¨å…¥**å…¨å±€æ–¹æ³•**ï¼Œé€šå¸¸åœ¨å¼€å‘é¡¹ç›®çš„å…¥å£æ–‡ä»¶ç”¨çš„ä¼šå¾ˆå¤šï¼Œæ¯”å¦‚æŒ‚è½½**å…¨å±€ç»„ä»¶**ã€**æ·»åŠ æŒ‡ä»¤**ã€**ä½¿ç”¨æ’ä»¶**ç­‰ã€‚

### å®šä¹‰å®ä¾‹ç›¸å…³ï¼š [src/core/instance/index.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/index.js)

- ä½œç”¨
  - 1. å®šä¹‰**Vue**æ„é€ å™¨ï¼Œ
  - 2. ä¸º**Vue**å®ä¾‹æ³¨å…¥`API`
- æ ¸å¿ƒæºç 

  ```javascript
  function Vue(options) {
    this._init(options);
  }

  initMixin(Vue); // åˆå§‹åŒ– this._init æ–¹æ³•
  // å…¶ä»–å®ä¾‹å±æ€§å’Œæ–¹æ³•ç”±ä¸‹é¢è¿™äº›æ–¹æ³•æ··å…¥
  stateMixin(Vue);
  eventsMixin(Vue);
  lifecycleMixin(Vue);
  renderMixin(Vue);
  ```

  æˆ‘ä»¬ç†ŸçŸ¥çš„**å®ä¾‹æ–¹æ³•**åŸºæœ¬éƒ½æ¥è‡ªè¿™é‡Œ

  1. stateMixin
     å®šä¹‰`$data`ã€`$props`ã€`$set`ã€`$delete`ã€`$watch`
  2. eventsMixin
     å®šä¹‰`$on`ã€`emit`ã€`off`ã€`once`
  3. lifecycleMixin
     å®šä¹‰`_update`ã€`$forceUpdate`ã€`$destory`
  4. renderMixin
     å®šä¹‰`$nextTick`ã€`_render`

     ä¸º**å®ä¾‹**æ³¨å…¥**æ–¹æ³•**ï¼ŒåŸºæœ¬å¹³æ—¶å·¥ä½œç”¨éƒ½æœ‰æ‰€æ¶‰åŠï¼Œå¼€å‘é¡¹ç›®ç”¨çš„æœ€å¤šçš„**å®ä¾‹ æ–¹æ³•**éƒ½æ¥è‡ªè¿™é‡Œ

### å®ä¾‹çš„åˆå§‹åŒ–ï¼šthis.\_init [src/core/instance/init.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/init.js#L16)

- ä½œç”¨

  - è°ƒç”¨ `mergeOptions` åˆå¹¶ `Vue.options` å’Œ `new Vue`ä¼ å…¥çš„å‚æ•°ï¼Œèµ‹å€¼ç»™`vm.$options`
  - ä¼´éšç€**ç”Ÿå‘½å‘¨æœŸ**çš„æ‰§è¡Œï¼Œä¸º**å®ä¾‹**æ·»åŠ å±æ€§ã€æ·»åŠ äº‹ä»¶ç›‘å¬ï¼ˆç»„ä»¶é€šä¿¡ï¼‰ã€åˆå§‹åŒ–æ¸²æŸ“ç›¸å…³ã€æ‰§è¡Œæ•°æ®å“åº”å¼ç­‰ç­‰ï¼Œæœ€åè°ƒç”¨`$mount`å°†ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢

- æ ¸å¿ƒæºç 

  ```javascript
  vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || {}, vm);
  initLifecycle(vm); // å®ä¾‹å±æ€§ï¼š$parent,$root,$children,$refs
  initEvents(vm); // ç›‘å¬_parentListeners
  initRender(vm); // æ’æ§½è§£æï¼Œ$slots,$scopeSlots,  $createElement()
  callHook(vm, 'beforeCreate');
  // æ¥ä¸‹æ¥éƒ½æ˜¯å’Œç»„ä»¶çŠ¶æ€ç›¸å…³çš„æ•°æ®æ“ä½œ
  // inject/provide
  initInjections(vm); // æ³¨å…¥ç¥–è¾ˆä¼ é€’ä¸‹æ¥çš„æ•°æ®
  initState(vm); // æ•°æ®å“åº”å¼ï¼šprops,methods,data,computed,watch
  initProvide(vm); // æä¾›ç»™åä»£ï¼Œç”¨æ¥éš”ä»£ä¼ é€’å‚æ•°
  callHook(vm, 'created');

  // å¦‚æœè®¾ç½®äº† elï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œ$mount()
  if (vm.$options.el) {
    vm.$mount(vm.$options.el);
  }
  ```

  æˆ‘ä»¬ç†ŸçŸ¥çš„**å®ä¾‹æ–¹æ³•**åŸºæœ¬éƒ½æ¥è‡ªè¿™é‡Œ

  1. initLifecycle
     å®šä¹‰`vm.$parent`ã€`vm.$root`ã€`vm.$refs`ã€`vm.$children`
  2. initEvents
     å®šä¹‰`vm._events`ã€`updateComponentListeners(vm.$listeners)`
  3. initRender
     å®šä¹‰`vm._c`ã€`vm.$createElement`
  4. initInjections
     ä¾æ¬¡æ‰§è¡Œ`resolveInject`ã€`defineReactive`
  5. initState
     å®šä¹‰`initProps`ã€`initMethods`ã€`initData`ã€`initComputed`ã€`initWatch`
  6. initProvide
     å®šä¹‰`vm._provide`

     &emsp;&emsp;åŒæ ·ä¹Ÿæ˜¯å®šä¹‰**å®ä¾‹**ä¸Šçš„å±æ€§åŠæ–¹æ³•ï¼Œä¸ä¸Šä¸€æ­¥ä¸åŒçš„æ˜¯ï¼Œä¸Šä¸ªè¿‡ç¨‹å®šä¹‰çš„**api**å¤§å¤šæ˜¯å¹³æ—¶å·¥ä½œå†™ä¸šåŠ¡ç”¨çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹æä¾›çš„æ–¹æ³•åŸºæœ¬éƒ½ä¸ºåç»­çš„æºç æœåŠ¡ï¼Œå¦å¤–`initLifecycle`ä¸­å®šä¹‰çš„å±æ€§å¹³æ—¶å†™**ç»„ä»¶åº“**çš„å°ä¼™ä¼´å¯èƒ½å¾ˆç†Ÿæ‚‰ã€‚

### æ¸²æŸ“ï¼š$mount ä¸ mountComponent [/src/core/instance/lifecycle.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/lifecycle.js#L141)

`$mount`åœ¨åˆå§‹åŒ–æ—¶åˆ†åˆ«è¢«æ‰©å±•äº†**ç¼–è¯‘å™¨**æ–¹æ³•å’Œ**è¿è¡Œæ—¶**æ–¹æ³•ï¼Œæ ¸å¿ƒåœ¨ä¸**è¿è¡Œæ—¶**ä¸ºå…¶æ‰©å±•äº†`mountComponent`ï¼Œè¿™æ˜¯**ç»„ä»¶æŒ‚è½½çš„å…¥å£**ğŸš©

- ä½œç”¨ï¼šç»„ä»¶åˆå§‹åŒ–å’Œæ›´æ–°æœ€é‡è¦çš„æµç¨‹ä¹‹ä¸€ï¼Œä¸º`updateComponent`èµ‹å€¼**æ›´æ–°å‡½æ•°**ï¼Œåˆ›å»º**Watcher**
- æ ¸å¿ƒæºç 

  ```javascript
  if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
    // ...
  } else {
    updateComponent = () => {
      vm._update(vm._render(), hydrating);
    };
  }

  // we set this to vm._watcher inside the watcher's constructor
  // since the watcher's initial patch may call $forceUpdate (e.g. inside child
  // component's mounted hook), which relies on vm._watcher being already defined
  new Watcher(
    vm,
    updateComponent,
    noop,
    {
      before() {
        if (vm._isMounted && !vm._isDestroyed) {
          callHook(vm, 'beforeUpdate');
        }
      },
    },
    true /* isRenderWatcher */
  );
  ```

  &emsp;&emsp;åœ¨ Vue ä¸­ï¼Œæ‰€æœ‰çš„æ¸²æŸ“éƒ½ç”± **Watcherï¼ˆrender Watcherï¼‰** å®Œæˆï¼ŒåŒ…æ‹¬**åˆå§‹åŒ–æ¸²æŸ“**å’Œ**ç»„ä»¶æ›´æ–°**ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ç»“æŸåï¼Œå¯ä»¥åœ¨é¡µé¢ä¸Šçœ‹åˆ°çœŸå® dom çš„æ ·å­ã€‚

## æµç¨‹æ¢³ç†

1. é¦–å…ˆåˆå§‹åŒ–**å…¨å±€**çš„é™æ€æ–¹æ³•ï¼Œcomponentsã€filterã€directiveã€‚setã€delete ç­‰ï¼Œ
2. ç„¶åå®šä¹‰**Vue å®ä¾‹**çš„æ–¹æ³•ï¼Œ
3. æ¥ç€æ‰§è¡Œ`init`æ–¹æ³•è¿›è¡Œ**å®ä¾‹**çš„åˆå§‹åŒ–ï¼Œä¼´éšç€**ç”Ÿå‘½å‘¨æœŸ**çš„è¿›è¡Œæ‰§è¡Œåˆå§‹åŒ–å±æ€§ã€äº‹ä»¶ç›‘å¬ã€æ•°æ®å“åº”å¼ï¼Œæœ€åè°ƒç”¨`$mount`å°†ç»„ä»¶æŒ‚è½½åˆ°é¡µé¢ä¸Š

## æ€»ç»“ä¸æ€è€ƒ

1. ä¸ºä»€ä¹ˆ`$mount`è¦ç»è¿‡æ‰©å±•ï¼Ÿ<br>

   ä¸ºäº†æ–¹ä¾¿**è·¨å¹³å°å¼€å‘**ï¼Œå› ä¸º**Vue2**æ–°å¢äº†**Weex**ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å‘å¹³å°æ³¨å…¥ç‰¹æœ‰çš„æ–¹æ³•

2. åœ¨`mergeOptions`ä¸­å‘ç°æœ‰ä¸ªç›‘å¬äº‹ä»¶ç»‘å®šçš„æ“ä½œç”¨äºç»„ä»¶é€šä¿¡æ—¶ï¼Œå…¶é€šä¿¡æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ<br/>
   å½“å‰ç»„ä»¶åœ¨`mergeOptions`æ—¶æœ‰ä¸€ä¸ªå±æ€§`parentListener`ç”¨æ¥å­˜æ”¾çˆ¶ç»„ä»¶é€šè¿‡ props ç»‘å®šçš„äº‹ä»¶ï¼Œç»„ä»¶ä¼šé€šè¿‡`$on`å°†æ³¨å†Œåˆ°è‡ªèº«ï¼Œåœ¨ä½¿ç”¨æ—¶ç›´æ¥`$emit`è§¦å‘å³å¯

3. ç”Ÿå‘½å‘¨æœŸçš„åç§°åŠåº”ç”¨ï¼š

   - 2.1. åˆ†ç±»åˆ—ä¸¾

     - åˆå§‹åŒ–é˜¶æ®µï¼šbeforeCreateã€createdã€beforeMountã€mounted
     - æ›´æ–°é˜¶æ®µï¼šbeforeUpdateã€updated
     - é”€æ¯é˜¶æ®µï¼šbeforeDestroyã€destroyed

   - 2.2. åº”ç”¨ï¼š

     - created æ—¶ï¼Œæ‰€æœ‰æ•°æ®å‡†å¤‡å°±ç»ªï¼Œé€‚åˆåšæ•°æ®è·å–ã€èµ‹å€¼ç­‰æ•°æ®æ“ä½œ
     - mounted æ—¶ï¼Œ$el å·²ç”Ÿæˆï¼Œå¯ä»¥è·å– domï¼›å­ç»„ä»¶ä¹Ÿå·²æŒ‚è½½ï¼Œå¯ä»¥è®¿é—®å®ƒä»¬
     - updated æ—¶ï¼Œæ•°å€¼å˜åŒ–å·²ä½œç”¨äº domï¼Œå¯ä»¥è·å– dom æœ€æ–°çŠ¶æ€
     - destroyed æ—¶ï¼Œç»„ä»¶å®ä¾‹å·²é”€æ¯ï¼Œé€‚åˆå–æ¶ˆå®šæ—¶å™¨ç­‰æ“ä½œ
